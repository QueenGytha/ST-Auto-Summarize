#!/usr/bin/env node

import { readdir, writeFile } from 'fs/promises';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const macrosDir = join(__dirname, '..', 'macros');
const indexPath = join(macrosDir, 'index.js');

async function generateMacroIndex() {
  // Read all files in macros directory
  const files = await readdir(macrosDir);

  // Filter to .js files, exclude index.js
  const macroFiles = files
    .filter(f => f.endsWith('.js') && f !== 'index.js')
    .map(f => f.replace('.js', ''));

  // Generate index.js content
  const content = `// Auto-generated macro registry
// This file is automatically generated by scripts/generate-macro-index.js
// DO NOT EDIT MANUALLY - run 'npm run generate-macros' to regenerate

// Discovered macro files: ${macroFiles.join(', ')}
const macroFiles = ${JSON.stringify(macroFiles, null, 2)};

// Dynamic import and registration
const macroModules = await Promise.all(
  macroFiles.map(file => import(\`./\${file}.js\`))
);

// Build MACRO_NAMES object from all modules
export const MACRO_NAMES = {};
for (const mod of macroModules) {
  const upperName = mod.name.toUpperCase().replace(/-/g, '_');
  MACRO_NAMES[upperName] = mod.name;
}

// Build macroBuilders object for easy access
export const macroBuilders = {};
for (const mod of macroModules) {
  macroBuilders[mod.name] = mod.build;
}

// Build macroDescriptions for documentation
export const macroDescriptions = {};
for (const mod of macroModules) {
  macroDescriptions[mod.name] = mod.description;
}

// Helper to get builder by name
export function getMacroBuilder(macroName) {
  return macroBuilders[macroName];
}

// Helper to build macro value
export function buildMacroValue(macroName, ...args) {
  const builder = getMacroBuilder(macroName);
  if (!builder) {
    throw new Error(\`No builder found for macro: \${macroName}\`);
  }
  return builder(...args);
}

// Re-export substitute functions from promptUtils
export { substitute_params, substitute_conditionals } from '../promptUtils.js';
`;

  await writeFile(indexPath, content, 'utf8');
  console.log(`âœ“ Generated macros/index.js with ${macroFiles.length} macros`);
  console.log(`  Macros: ${macroFiles.join(', ')}`);
}

generateMacroIndex().catch(err => {
  console.error('Failed to generate macro index:', err);
  process.exit(1);
});
