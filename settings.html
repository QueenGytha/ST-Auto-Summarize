<div id="auto_recap_memory_settings" data-testid="extension-settings-panel" class="auto_recap_memory_settings_content">
    <div class="inline-drawer">

        <div class="inline-drawer-toggle inline-drawer-header">
            <div class="flex-container alignitemscenter margin0">
                <b>ST-Auto-Recap</b>
                <i id="auto_recap_popout_button" data-testid="extension-popout" class="fa-solid fa-window-restore menu_button margin0"></i>
            </div>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
        </div>

        <div class="inline-drawer-content">

            <!-- transferred to popup -->
            <div class="auto_recap_memory_settings_content">
                <hr>

                <div class="flex-container justifyspacebetween alignitemscenter">
                    <button id="toggle_chat_memory" data-testid="memory-toggle" class="menu_button flex2" title="Toggle whether memory is enabled for this chat specifically (overrides all settings)."><span>Toggle Memory</span></button>
                    <button id="refresh_memory" data-testid="memory-refresh" class="menu_button fa-solid fa-sync margin0" title="Just refreshes which memories are included and re-renders the memories under each message, doesn't change recaps. This is done automatically all the time, the button is here just in case."></button>
                </div>

                <hr>

                <div class="flex-container alignitemscenter margin0">
                    <h4 class="margin0">Configuration Profiles</h4>
                    <button id="import_profile" data-testid="profile-import" class="menu_button fa-solid fa-file-import" title="Import a config profile"></button>
                    <button id="export_profile" data-testid="profile-export" class="menu_button fa-solid fa-file-export" title="Export the current config profile"></button>
                    <input id="import_file" data-testid="profile-import-file" type="file" hidden="" accept=".json">
                </div>
                <div class="flex-container justifyspacebetween alignitemscenter">
                    <select id="profile" data-testid="profile-select" class="flex1 text_pole" title="The currently selected profile"></select>
                    <button id="rename_profile" data-testid="profile-rename" class="menu_button fa-solid fa-pencil interactable" title="Rename current profile" tabindex="0"></button>
                    <button id="new_profile" data-testid="profile-new" class="menu_button fa-solid fa-file-circle-plus interactable" title="Create new profile" tabindex="0"></button>
                    <button id="restore_profile" data-testid="profile-restore" class="menu_button fa-solid fa-recycle interactable" title="Restore current profile" tabindex="0"></button>
                    <button id="delete_profile" data-testid="profile-delete" class="menu_button fa-solid fa-trash-can interactable" title="Delete current profile" tabindex="0"></button>
                </div>
                <div class="flex-container justifyspacebetween alignitemscenter">
                    <button id="character_profile" data-testid="profile-character-autoload" class="menu_button interactable" title="Auto-load profile for current character" tabindex="0"><i class="fa-solid fa-unlock" style="margin-right: 1em"></i>Character</button>
                    <button id="chat_profile" data-testid="profile-chat-autoload" class="menu_button interactable" title="Auto-load profile for current chat" tabindex="0"><i class="fa-solid fa-unlock" style="margin-right: 1em"></i>Chat</button>
                    <label class="checkbox_label" title="Show a notification upon switching profiles">
                        <input id="notify_on_profile_switch" data-testid="profile-notify-switch" type="checkbox" />
                        <span>Notify on Switch</span>
                    </label>
                </div>

                <!-- First-Hop Proxy Integration -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">First-Hop Proxy Integration <i class="fa-solid fa-info-circle" title="Add metadata to LLM requests for downstream proxy logging and tracking."></i></h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <div class="note-block">
                            <i class="fa-solid fa-circle-check"></i>
                            <span><strong>Auto-Detection Enabled:</strong> Chat metadata is automatically sent when your connection profile uses <code>http://localhost:8765</code> as the proxy server. No manual configuration needed.</span>
                        </div>

                        <label title="Force metadata injection even when first-hop proxy is not auto-detected. Enable this if auto-detection fails on your device." class="checkbox_label">
                            <input id="first_hop_proxy_manual_override" data-testid="proxy-manual-override" type="checkbox" />
                            <span>Always Send Metadata</span>
                        </label>

                        <label title="When enabled, suppress global/character/persona lorebooks during generation (only chat lorebooks will be included). This prevents conflicts between auto-generated lorebooks and manually-created ones." class="checkbox_label">
                            <input id="suppress_other_lorebooks" data-testid="proxy-suppress-other-lorebooks" type="checkbox" />
                            <span>Suppress Non-Chat Lorebooks</span>
                        </label>

                        <div class="note-block">
                            <i class="fa-solid fa-info-circle"></i>
                            <span>When using the first-hop proxy (<code>localhost:8765</code>), metadata is added to LLM requests that your proxy can parse and strip before forwarding to the LLM. This allows your proxy to log requests with chat context.</span>
                        </div>
                    </div>
                </div>

                <!-- Operations Configuration -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Operations Configuration <i class="fa-solid fa-info-circle" title="Configure prompts and settings for all recap operations. Create presets and sticky them to specific characters or chats."></i></h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">

                        <!-- Preset Selector Section -->
                        <div class="auto_recap_operations_preset_section" data-testid="operations-preset-section">
                            <div class="flex-container alignitemscenter margin0">
                                <label class="flex1">
                                    <span>Active Preset:</span>
                                    <select id="auto_recap_preset_selector" data-testid="operations-preset-selector" class="text_pole">
                                        <option value="Default">Default</option>
                                    </select>
                                </label>
                                <span id="auto_recap_preset_source_badge" data-testid="operations-preset-badge" class="auto_recap_preset_badge fa-solid fa-file" title="Using profile default preset"></span>
                            </div>

                            <textarea id="auto_recap_preset_description" data-testid="operations-preset-description" class="text_pole" placeholder="Preset description (optional)" style="font-size: 0.9em; margin: 5px 0; min-height: 50px; resize: vertical;"></textarea>

                            <!-- Preset Action Buttons -->
                            <div class="flex-container justifyspacebetween alignitemscenter" style="margin-top: 10px; gap: 5px;">
                                <button id="auto_recap_preset_rename" data-testid="operations-preset-rename" class="menu_button fa-solid fa-pencil" title="Rename this preset" disabled></button>
                                <button id="auto_recap_preset_delete" data-testid="operations-preset-delete" class="menu_button fa-solid fa-trash-can" title="Delete this preset" disabled></button>
                                <button id="auto_recap_preset_import" data-testid="operations-preset-import" class="menu_button fa-solid fa-file-import" title="Import preset from JSON file"></button>
                                <button id="auto_recap_preset_export" data-testid="operations-preset-export" class="menu_button fa-solid fa-file-export" title="Export preset to JSON file"></button>
                                <button id="auto_recap_preset_duplicate" data-testid="operations-preset-duplicate" class="menu_button fa-solid fa-copy" title="Create a copy of this preset"></button>
                            </div>

                            <!-- Sticky Preset Buttons -->
                            <div class="flex-container justifyspacebetween alignitemscenter" style="margin-top: 5px; gap: 5px;">
                                <button id="auto_recap_preset_sticky_character" data-testid="operations-preset-sticky-character" class="menu_button" title="Auto-load this preset for current character">
                                    <i class="fa-solid fa-unlock" style="margin-right: 1em"></i> Character
                                </button>
                                <button id="auto_recap_preset_sticky_chat" data-testid="operations-preset-sticky-chat" class="menu_button" title="Auto-load this preset for current chat">
                                    <i class="fa-solid fa-unlock" style="margin-right: 1em"></i> Chat
                                </button>
                            </div>

                            <input id="auto_recap_preset_import_file" data-testid="operations-preset-import-file" type="file" hidden accept=".json">
                        </div>

                        <hr style="margin: 15px 0;">

                        <!-- Operation Type Selectors -->
                        <!-- Auto-Lorebooks: Bulk Populate -->
                        <div class="auto_recap_operation_type_section" data-testid="operation-type-lorebooks-bulk-populate">
                            <div class="flex-container justifyspacebetween alignitemscenter" style="gap: 5px;">
                                <span>Auto-Lorebooks: Bulk Populate:</span>
                                <div style="display: flex; gap: 5px;">
                                    <button data-operation-type="auto_lorebooks_bulk_populate" class="auto_recap_artifact_edit menu_button fa-solid fa-pencil" data-testid="artifact-edit-lorebooks-bulk-populate" title="Edit this artifact"></button>
                                    <button data-operation-type="auto_lorebooks_bulk_populate" class="auto_recap_artifact_rename menu_button fa-solid fa-i-cursor" data-testid="artifact-rename-lorebooks-bulk-populate" title="Rename this artifact" disabled></button>
                                    <button data-operation-type="auto_lorebooks_bulk_populate" class="auto_recap_artifact_delete menu_button fa-solid fa-trash-can" data-testid="artifact-delete-lorebooks-bulk-populate" title="Delete this artifact" disabled></button>
                                    <button data-operation-type="auto_lorebooks_bulk_populate" class="auto_recap_artifact_duplicate menu_button fa-solid fa-copy" data-testid="artifact-duplicate-lorebooks-bulk-populate" title="Duplicate this artifact"></button>
                                </div>
                            </div>
                            <select id="auto_recap_artifact_auto_lorebooks_bulk_populate" data-testid="artifact-lorebooks-bulk-populate" class="text_pole" style="margin-top: 5px;">
                                <option value="Default">Default</option>
                            </select>
                        </div>

                        <!-- Auto Scene Break -->
                        <div class="auto_recap_operation_type_section" data-testid="operation-type-auto-scene-break">
                            <div class="flex-container justifyspacebetween alignitemscenter" style="gap: 5px;">
                                <span>Auto Scene Break Detection:</span>
                                <div style="display: flex; gap: 5px;">
                                    <button data-operation-type="auto_scene_break" class="auto_recap_artifact_edit menu_button fa-solid fa-pencil" data-testid="artifact-edit-auto-scene-break" title="Edit this artifact"></button>
                                    <button data-operation-type="auto_scene_break" class="auto_recap_artifact_rename menu_button fa-solid fa-i-cursor" data-testid="artifact-rename-auto-scene-break" title="Rename this artifact" disabled></button>
                                    <button data-operation-type="auto_scene_break" class="auto_recap_artifact_delete menu_button fa-solid fa-trash-can" data-testid="artifact-delete-auto-scene-break" title="Delete this artifact" disabled></button>
                                    <button data-operation-type="auto_scene_break" class="auto_recap_artifact_duplicate menu_button fa-solid fa-copy" data-testid="artifact-duplicate-auto-scene-break" title="Duplicate this artifact"></button>
                                </div>
                            </div>
                            <select id="auto_recap_artifact_auto_scene_break" data-testid="artifact-auto-scene-break" class="text_pole" style="margin-top: 5px;">
                                <option value="Default">Default</option>
                            </select>
                        </div>

                        <!-- Scene Recap Error Detection -->
                        <div class="auto_recap_operation_type_section" data-testid="operation-type-scene-recap-error">
                            <div class="flex-container justifyspacebetween alignitemscenter" style="gap: 5px;">
                                <span>Scene Recap Error Detection:</span>
                                <div style="display: flex; gap: 5px;">
                                    <button data-operation-type="scene_recap_error_detection" class="auto_recap_artifact_edit menu_button fa-solid fa-pencil" data-testid="artifact-edit-scene-recap-error" title="Edit this artifact"></button>
                                    <button data-operation-type="scene_recap_error_detection" class="auto_recap_artifact_rename menu_button fa-solid fa-i-cursor" data-testid="artifact-rename-scene-recap-error" title="Rename this artifact" disabled></button>
                                    <button data-operation-type="scene_recap_error_detection" class="auto_recap_artifact_delete menu_button fa-solid fa-trash-can" data-testid="artifact-delete-scene-recap-error" title="Delete this artifact" disabled></button>
                                    <button data-operation-type="scene_recap_error_detection" class="auto_recap_artifact_duplicate menu_button fa-solid fa-copy" data-testid="artifact-duplicate-scene-recap-error" title="Duplicate this artifact"></button>
                                </div>
                            </div>
                            <select id="auto_recap_artifact_scene_recap_error_detection" data-testid="artifact-scene-recap-error" class="text_pole" style="margin-top: 5px;">
                                <option value="Default">Default</option>
                            </select>
                        </div>

                        <!-- Scene Recap -->
                        <div class="auto_recap_operation_type_section" data-testid="operation-type-scene-recap">
                            <div class="flex-container justifyspacebetween alignitemscenter" style="gap: 5px;">
                                <span>Scene Recap:</span>
                                <div style="display: flex; gap: 5px;">
                                    <button data-operation-type="scene_recap" class="auto_recap_artifact_edit menu_button fa-solid fa-pencil" data-testid="artifact-edit-scene-recap" title="Edit this artifact"></button>
                                    <button data-operation-type="scene_recap" class="auto_recap_artifact_rename menu_button fa-solid fa-i-cursor" data-testid="artifact-rename-scene-recap" title="Rename this artifact" disabled></button>
                                    <button data-operation-type="scene_recap" class="auto_recap_artifact_delete menu_button fa-solid fa-trash-can" data-testid="artifact-delete-scene-recap" title="Delete this artifact" disabled></button>
                                    <button data-operation-type="scene_recap" class="auto_recap_artifact_duplicate menu_button fa-solid fa-copy" data-testid="artifact-duplicate-scene-recap" title="Duplicate this artifact"></button>
                                </div>
                            </div>
                            <select id="auto_recap_artifact_scene_recap" data-testid="artifact-scene-recap" class="text_pole" style="margin-top: 5px;">
                                <option value="Default">Default</option>
                            </select>
                        </div>

                        <!-- Running Scene Recap -->
                        <div class="auto_recap_operation_type_section" data-testid="operation-type-running-scene-recap">
                            <div class="flex-container justifyspacebetween alignitemscenter" style="gap: 5px;">
                                <span>Running Scene Recap:</span>
                                <div style="display: flex; gap: 5px;">
                                    <button data-operation-type="running_scene_recap" class="auto_recap_artifact_edit menu_button fa-solid fa-pencil" data-testid="artifact-edit-running-scene-recap" title="Edit this artifact"></button>
                                    <button data-operation-type="running_scene_recap" class="auto_recap_artifact_rename menu_button fa-solid fa-i-cursor" data-testid="artifact-rename-running-scene-recap" title="Rename this artifact" disabled></button>
                                    <button data-operation-type="running_scene_recap" class="auto_recap_artifact_delete menu_button fa-solid fa-trash-can" data-testid="artifact-delete-running-scene-recap" title="Delete this artifact" disabled></button>
                                    <button data-operation-type="running_scene_recap" class="auto_recap_artifact_duplicate menu_button fa-solid fa-copy" data-testid="artifact-duplicate-running-scene-recap" title="Duplicate this artifact"></button>
                                </div>
                            </div>
                            <select id="auto_recap_artifact_running_scene_recap" data-testid="artifact-running-scene-recap" class="text_pole" style="margin-top: 5px;">
                                <option value="Default">Default</option>
                            </select>
                        </div>

                        <!-- Auto-Lorebooks: Entry Lookup -->
                        <div class="auto_recap_operation_type_section" data-testid="operation-type-lorebooks-lookup">
                            <div class="flex-container justifyspacebetween alignitemscenter" style="gap: 5px;">
                                <span>Auto-Lorebooks: Entry Lookup:</span>
                                <div style="display: flex; gap: 5px;">
                                    <button data-operation-type="auto_lorebooks_recap_lorebook_entry_lookup" class="auto_recap_artifact_edit menu_button fa-solid fa-pencil" data-testid="artifact-edit-lorebooks-lookup" title="Edit this artifact"></button>
                                    <button data-operation-type="auto_lorebooks_recap_lorebook_entry_lookup" class="auto_recap_artifact_rename menu_button fa-solid fa-i-cursor" data-testid="artifact-rename-lorebooks-lookup" title="Rename this artifact" disabled></button>
                                    <button data-operation-type="auto_lorebooks_recap_lorebook_entry_lookup" class="auto_recap_artifact_delete menu_button fa-solid fa-trash-can" data-testid="artifact-delete-lorebooks-lookup" title="Delete this artifact" disabled></button>
                                    <button data-operation-type="auto_lorebooks_recap_lorebook_entry_lookup" class="auto_recap_artifact_duplicate menu_button fa-solid fa-copy" data-testid="artifact-duplicate-lorebooks-lookup" title="Duplicate this artifact"></button>
                                </div>
                            </div>
                            <select id="auto_recap_artifact_auto_lorebooks_recap_lorebook_entry_lookup" data-testid="artifact-lorebooks-lookup" class="text_pole" style="margin-top: 5px;">
                                <option value="Default">Default</option>
                            </select>
                        </div>

                        <!-- Auto-Lorebooks: Entry Deduplicate -->
                        <div class="auto_recap_operation_type_section" data-testid="operation-type-lorebooks-deduplicate">
                            <div class="flex-container justifyspacebetween alignitemscenter" style="gap: 5px;">
                                <span>Auto-Lorebooks: Entry Deduplicate:</span>
                                <div style="display: flex; gap: 5px;">
                                    <button data-operation-type="auto_lorebooks_recap_lorebook_entry_deduplicate" class="auto_recap_artifact_edit menu_button fa-solid fa-pencil" data-testid="artifact-edit-lorebooks-deduplicate" title="Edit this artifact"></button>
                                    <button data-operation-type="auto_lorebooks_recap_lorebook_entry_deduplicate" class="auto_recap_artifact_rename menu_button fa-solid fa-i-cursor" data-testid="artifact-rename-lorebooks-deduplicate" title="Rename this artifact" disabled></button>
                                    <button data-operation-type="auto_lorebooks_recap_lorebook_entry_deduplicate" class="auto_recap_artifact_delete menu_button fa-solid fa-trash-can" data-testid="artifact-delete-lorebooks-deduplicate" title="Delete this artifact" disabled></button>
                                    <button data-operation-type="auto_lorebooks_recap_lorebook_entry_deduplicate" class="auto_recap_artifact_duplicate menu_button fa-solid fa-copy" data-testid="artifact-duplicate-lorebooks-deduplicate" title="Duplicate this artifact"></button>
                                </div>
                            </div>
                            <select id="auto_recap_artifact_auto_lorebooks_recap_lorebook_entry_deduplicate" data-testid="artifact-lorebooks-deduplicate" class="text_pole" style="margin-top: 5px;">
                                <option value="Default">Default</option>
                            </select>
                        </div>

                        <!-- Auto-Lorebooks: Recap Merge -->
                        <div class="auto_recap_operation_type_section" data-testid="operation-type-lorebooks-merge">
                            <div class="flex-container justifyspacebetween alignitemscenter" style="gap: 5px;">
                                <span>Auto-Lorebooks: Recap Merge:</span>
                                <div style="display: flex; gap: 5px;">
                                    <button data-operation-type="auto_lorebooks_recap_merge" class="auto_recap_artifact_edit menu_button fa-solid fa-pencil" data-testid="artifact-edit-lorebooks-merge" title="Edit this artifact"></button>
                                    <button data-operation-type="auto_lorebooks_recap_merge" class="auto_recap_artifact_rename menu_button fa-solid fa-i-cursor" data-testid="artifact-rename-lorebooks-merge" title="Rename this artifact" disabled></button>
                                    <button data-operation-type="auto_lorebooks_recap_merge" class="auto_recap_artifact_delete menu_button fa-solid fa-trash-can" data-testid="artifact-delete-lorebooks-merge" title="Delete this artifact" disabled></button>
                                    <button data-operation-type="auto_lorebooks_recap_merge" class="auto_recap_artifact_duplicate menu_button fa-solid fa-copy" data-testid="artifact-duplicate-lorebooks-merge" title="Duplicate this artifact"></button>
                                </div>
                            </div>
                            <select id="auto_recap_artifact_auto_lorebooks_recap_merge" data-testid="artifact-lorebooks-merge" class="text_pole" style="margin-top: 5px;">
                                <option value="Default">Default</option>
                            </select>
                        </div>

                    </div>
                </div>

                <!-- Scene Recap -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Scene Recap <i class="fa-solid fa-info-circle" title="Recap each scene break and use the results to build the running scene recap."></i></h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <label title="Width of the scene navigator bar in pixels.">
                            <span>Navigator Bar Width (pixels):</span>
                            <input id="scene_recap_navigator_width" data-testid="scene-nav-width" class="text_pole" type="number" min="30" max="500" step="1" />
                        </label>
                        <label title="Font size for scene names in the navigator bar (in pixels).">
                            <span>Navigator Font Size (pixels):</span>
                            <input id="scene_recap_navigator_font_size" data-testid="scene-nav-font-size" class="text_pole" type="number" min="8" max="24" step="1" />
                        </label>
                        <!-- Standalone scene-name auto-generation removed. Scene name is part of the recap output. -->
                        <label class="checkbox_label" title="New scene recaps will start collapsed by default (showing only the scene name). Existing scenes keep their current state.">
                            <input id="scene_recap_default_collapsed" data-testid="scene-default-collapsed" type="checkbox" />
                            <span>Collapse New Scenes by Default</span>
                        </label>
                        <label class="checkbox_label" title="Append message range to auto-generated scene names (e.g., 'Scene Name 159-254'). Only applies to newly generated scene names.">
                            <input id="scene_name_append_range" data-testid="scene-name-append-range" type="checkbox" />
                            <span>Append Message Range to Scene Names</span>
                        </label>
                        <label class="checkbox_label" title="Include active lorebook entries in the scene recap prompt to provide context. Only new or changed information from lorebooks will be included.">
                            <input id="scene_recap_include_active_setting_lore" data-testid="scene-include-active-setting-lore" type="checkbox" />
                            <span>Include Active setting_lore Entries</span>
                        </label>
                        <table>
                            <tr>
                                <td><span>Include Message Types</span></td>
                                <td>
                                    <select id="scene_recap_message_types" data-testid="scene-message-types" class="text_pole">
                                        <option value="user">User Messages Only</option>
                                        <option value="character">AI Messages Only</option>
                                        <option value="both">All Messages</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <span>Recap the last <span id="scene_recap_history_count_display" data-testid="scene-history-count-display">1</span> scenes</span>
                                </td>
                                <td>
                                    <input id="scene_recap_history_count" data-testid="scene-history-count" class="text_pole" type="number" min="1" max="99" value="1" />
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Running Scene Recap -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Running Scene Recap <i class="fa-solid fa-info-circle" title="Combine multiple scene recaps into a single cohesive memory. This is the recommended default behavior matching best practices."></i></h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <label title="Number of latest scene recaps to exclude from the running recap. Default: 1 (allows you to validate the latest scene recap before it's combined).">
                            <span>Exclude Latest <span id="running_scene_recap_exclude_latest_display" data-testid="running-exclude-latest-display">1</span> Scene(s)</span>
                            <input id="running_scene_recap_exclude_latest" data-testid="running-exclude-latest" class="text_pole" type="range" min="0" max="5" step="1" value="1" />
                        </label>
                        <small style="display:block; margin-bottom:0.5em;">Recommended: 1 (exclude latest scene to allow manual validation before combining)</small>

                        <label class="checkbox_label" title="Automatically generate running scene recap when new scene recaps are created.">
                            <input id="running_scene_recap_auto_generate" data-testid="running-auto-generate" type="checkbox" />
                            <span>Auto-generate on New Scene Recaps</span>
                        </label>

                        <label class="checkbox_label" title="Show version control buttons in the navbar to switch between, edit, or delete running recap versions.">
                            <input id="running_scene_recap_show_navbar" data-testid="running-show-navbar" type="checkbox" />
                            <span>Show Navbar Version Controls</span>
                        </label>

                        <button id="view_running_scene_recap" data-testid="running-view" class="menu_button" title="View/edit the current running scene recap"><span>View Running Recap</span></button>

                        <label title="Where to inject the running scene recap.">
                            <select id="running_scene_recap_position" data-testid="running-position" class="text_pole">
                                <option value="-1">Do not inject</option>
                                <option value="2">Before main prompt</option>
                                <option value="0">After main prompt</option>
                                <option value="1">In chat at depth</option>
                            </select>
                        </label>
                        <label title="Depth for in-chat injection.">
                            <input id="running_scene_recap_depth" data-testid="running-depth" class="text_pole inline_setting" type="number" min="0" max="99" />
                            <span>Depth</span>
                        </label>
                        <label title="Role for in-chat injection.">
                            <select id="running_scene_recap_role" data-testid="running-role" class="text_pole inline_setting">
                                <option value="0">System</option>
                                <option value="1">User</option>
                                <option value="2">Assistant</option>
                            </select>
                        </label>
                        <label class="checkbox_label" title="Include in World Info Scanning">
                            <input id="running_scene_recap_scan" data-testid="running-scan" type="checkbox" />
                            <span>Include in World Info Scanning</span>
                        </label>
                    </div>
                </div>

                <!-- Auto Scene Break Detection -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Auto Scene Break Detection <i class="fa-solid fa-info-circle" title="Automatically detect and mark scene breaks using AI analysis."></i></h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <!-- Removed master enable toggle: scene break detection is always available.
                             Behavior is governed by per-event options and manual run. -->
                        <label class="checkbox_label" title="Automatically check for scene breaks when chat loads.">
                            <input id="auto_scene_break_on_load" data-testid="auto-scene-on-load" type="checkbox" />
                            <span>Auto-check on Chat Load</span>
                        </label>
                        <label class="checkbox_label" title="Automatically check for scene breaks when new messages arrive.">
                            <input id="auto_scene_break_on_new_message" data-testid="auto-scene-on-message" type="checkbox" />
                            <span>Auto-check on New Messages</span>
                        </label>
                        <label class="checkbox_label" title="Automatically generate a scene recap when a scene break is detected. The recap generation will complete before checking the next message.">
                            <input id="auto_scene_break_generate_recap" data-testid="auto-scene-generate-recap" type="checkbox" />
                            <span>Auto-generate Scene Recap on Detection</span>
                        </label>

                        <label title="How many messages back from the latest to skip checking. 0 = check all including latest, 1 = skip latest, 2 = skip 2 latest, etc.">
                            <span>Message Offset (skip latest N messages): <span id="auto_scene_break_message_offset_value" data-testid="auto-scene-offset-display">4</span></span>
                            <input id="auto_scene_break_message_offset" data-testid="auto-scene-message-offset" class="text_pole" type="range" min="0" max="10" step="1" value="4" />
                        </label>
                        <small style="display:block; margin-bottom:0.5em;">Recommended: 2 (skip 2 latest messages to allow for swipes/regeneration)</small>

                        <label title="Which message types to check for scene breaks.">
                            <span>Check Which Messages:</span>
                            <select id="auto_scene_break_check_which_messages" data-testid="auto-scene-check-which" class="text_pole">
                                <option value="character">AI Messages Only</option>
                                <option value="user">User Messages Only</option>
                                <option value="both">Both User and AI Messages</option>
                            </select>
                        </label>
                        <small style="display:block; margin-bottom:0.5em;">Scene breaks typically occur in AI responses, but some users write them in their inputs too.</small>

                        <label title="Minimum number of filtered messages required before allowing the LLM to choose a scene break point. This prevents breaking too early in a scene.">
                            <span>Minimum Scene Length: <span id="auto_scene_break_minimum_scene_length_value" data-testid="auto-scene-min-length-display">4</span> messages</span>
                            <input id="auto_scene_break_minimum_scene_length" data-testid="auto-scene-min-length" class="text_pole" type="number" min="1" max="50" step="1" value="4" />
                        </label>
                        <small style="display:block; margin-bottom:0.5em;">Counts only messages matching the selected message type filter above.</small>
                    </div>
                </div>

                <!-- Error Detection -->
                <hr>
                <div class="inline-drawer" style="display: none;">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Recap Validation <i class="fa-solid fa-info-circle" title="Configure validation for recaps to ensure they meet your criteria"></i></h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <label class="checkbox_label" title="Enable two-step validation for recaps">
                            <input id="error_detection_enabled" data-testid="validation-enabled" type="checkbox" />
                            <span>Enable Recap Validation</span>
                        </label>

                <!-- Scene recap validation -->
                <label class="checkbox_label error_detection_setting" title="Enable validation for scene recaps">
                    <input id="scene_recap_error_detection_enabled" data-testid="validation-scene-enabled" type="checkbox" />
                    <span>Validate Scene Recaps</span>
                </label>
                <table class="scene_error_detection_container">
                    <tr>
                        <td><span>Scene Recap Max Retry Attempts</span></td>
                        <td><input id="scene_recap_error_detection_retries" data-testid="validation-scene-retries" class="text_pole scene_error_detection_setting" type="number" min="1" max="10" value="3"></td>
                    </tr>
                </table>
                    </div>
                </div>

                <!-- Auto-Hide -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Auto-Hide</h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <label title="Automatically hide all messages in scenes older than this many scenes (set -1 to disable)" class="checkbox_label">
                            <span>Auto Hide Messages Older Than The Last</span>
                            <input id="auto_hide_scene_count" data-testid="auto-hide-scene-count" class="text_pole widthUnset inline_setting" type="number" min="-1" max="999" />
                            <span>Scene(s) (-1 to disable)</span>
                        </label>
                    </div>
                </div>

                <!-- Misc. -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Misc.</h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <label title="Whether recap is enabled by default for new chats." class="checkbox_label">
                            <input id="default_chat_enabled" data-testid="misc-default-enabled" type="checkbox" />
                            <span>Enable Recap in New Chats</span>
                        </label>

                        <label title="Uses a global on/off state shared between all chats with this enabled. When unchecked, turning the extension on/off only applies to active chat." class="checkbox_label">
                            <input id="use_global_toggle_state" data-testid="misc-global-toggle" type="checkbox" />
                            <span>Use Global Toggle State</span>
                        </label>

                        <hr>

                        <label title="Correction factor for tokenizer discrepancies between SillyTavern and actual LLM providers. Values >1.0 increase estimates (for undercounting), values <1.0 decrease estimates (for overcounting). Claude models typically need 1.35 (35% undercount). OpenAI models use 1.0 (accurate).">
                            <input id="tokenizer_correction_factor" data-testid="token-correction-factor" class="text_pole widthUnset inline_setting" type="number" min="0.5" max="2.0" step="0.05" />
                            <span>Tokenizer Correction Factor</span>
                        </label>

                        <div class="note-block">
                            <i class="fa-solid fa-info-circle"></i>
                            <span>SillyTavern uses tokenizer approximations that may not match the provider's actual tokenizer. This multiplier adjusts token estimates for more accurate budget calculations. <strong>Recommended values:</strong> Claude: <code>1.35</code> (ST undercounts by ~35%), OpenAI: <code>1.0</code> (tiktoken is accurate).</span>
                        </div>
                    </div>
                </div>

                <!-- Auto-Lorebooks Settings -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Auto-Lorebooks</h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <div class="margin-bot-10px">
                            <label class="checkbox_label" for="autolorebooks-delete-on-chat-delete">
                                <input type="checkbox" id="autolorebooks-delete-on-chat-delete" data-testid="lorebook-delete-on-chat" />
                                <span>Delete lorebook when chat is deleted</span>
                            </label>
                        </div>

                        <div class="margin-bot-10px">
                            <label class="checkbox_label" for="autolorebooks-auto-reorder-alphabetically">
                                <input type="checkbox" id="autolorebooks-auto-reorder-alphabetically" data-testid="lorebook-auto-reorder" />
                                <span>Auto-reorder entries alphabetically when created or renamed</span>
                            </label>
                        </div>

                        <div class="margin-bot-10px">
                            <label for="autolorebooks-name-template">
                                <span>Lorebook naming template:</span>
                                <small class="displayBlock opacity50p">Available variables: {{char}}, {{chat}}</small>
                            </label>
                            <input type="text" id="autolorebooks-name-template" data-testid="lorebook-name-template" class="text_pole" placeholder="z-AutoLB-{{chat}}" />
                        </div>
                        <div class="margin-bot-10px">
                            <label>
                                <span>Supported lorebook entry types:</span>
                                <small class="displayBlock opacity50p">Applies to the {{lorebook_entry_types}} macro and registry generation. Values should be lowercase slugs.</small>
                            </label>
                            <div id="autolorebooks-entity-types-list" data-testid="lorebook-entity-types-list" class="margin-top-5px"></div>
                            <div class="flex-container alignitemscenter margin-top-5px" style="gap: 5px;">
                                <input type="text" id="autolorebooks-entity-type-input" data-testid="lorebook-entity-type-input" class="text_pole" placeholder="e.g. quest(entry:constant)" />
                                <button id="autolorebooks-add-entity-type" data-testid="lorebook-add-entity-type" class="menu_button">Add</button>
                                <button id="autolorebooks-restore-entity-types" data-testid="lorebook-restore-entity-types" class="menu_button fa-solid fa-recycle" title="Restore default types"></button>
                            </div>
                        </div>

                        <hr>

                        <h4>Recap-to-Lorebook Processing</h4>

                        <div class="margin-bot-10px">
                            <label class="checkbox_label" for="autolorebooks-recap-skip-duplicates">
                                <input type="checkbox" id="autolorebooks-recap-skip-duplicates" data-testid="lorebook-skip-duplicates" />
                                <span>Skip already processed recaps</span>
                            </label>
                        </div>

                        <div class="inline-drawer margin-top-10px">
                            <div class="inline-drawer-toggle inline-drawer-header">
                                <div class="flex-container alignitemscenter margin0">
                                    <span>Default Entry Properties (for new entries from recaps)</span>
                                </div>
                                <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                            </div>
                            <div class="inline-drawer-content">
                                <div class="margin-bot-10px">
                                    <label class="checkbox_label" for="autolorebooks-entry-exclude-recursion">
                                        <input type="checkbox" id="autolorebooks-entry-exclude-recursion" data-testid="lorebook-entry-exclude-recursion" />
                                        <span>Exclude Recursion (Non-recursable)</span>
                                    </label>
                                    <small class="displayBlock opacity50p">When checked, this entry will not trigger other entries recursively</small>
                                </div>

                                <div class="margin-bot-10px">
                                    <label class="checkbox_label" for="autolorebooks-entry-prevent-recursion">
                                        <input type="checkbox" id="autolorebooks-entry-prevent-recursion" data-testid="lorebook-entry-prevent-recursion" />
                                        <span>Prevent Further Recursion</span>
                                    </label>
                                    <small class="displayBlock opacity50p">When checked, this entry will not activate other entries recursively</small>
                                </div>

                                <div class="margin-bot-10px">
                                    <label class="checkbox_label" for="autolorebooks-entry-ignore-budget">
                                        <input type="checkbox" id="autolorebooks-entry-ignore-budget" data-testid="lorebook-entry-ignore-budget" />
                                        <span>Ignore Budget</span>
                                    </label>
                                    <small class="displayBlock opacity50p">When checked, this entry will be included ignoring budget constraints</small>
                                </div>

                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-entry-sticky">
                                        <span>Sticky (rounds):</span>
                                        <small class="displayBlock opacity50p">Number of message rounds to keep entry active</small>
                                    </label>
                                    <input type="number" id="autolorebooks-entry-sticky" data-testid="lorebook-entry-sticky" class="text_pole" min="0" max="10000" />
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <hr>
                <div class="flex-container justifyspacebetween alignitemscenter">
                    <button id="revert_settings" data-testid="settings-restore-defaults" class="menu_button flex1 margin0" title="Restore all settings to their default values. This completely resets all configuration options to factory defaults. Your saved profiles won't be affected.">
                        <span>Restore All Defaults</span>
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Artifact Editor Modal -->
<div id="auto_recap_artifact_editor_modal" data-testid="artifact-editor-modal" class="auto_recap_artifact_editor_modal" style="display: none;">
    <div class="auto_recap_artifact_editor_backdrop"></div>
    <div class="auto_recap_artifact_editor_dialog">
        <div class="auto_recap_artifact_editor_header">
            <h3 id="auto_recap_artifact_editor_title" data-testid="artifact-editor-title">Edit Operation Artifact</h3>
            <button id="auto_recap_artifact_editor_close" data-testid="artifact-editor-close" class="auto_recap_artifact_editor_close" title="Close">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>

        <div class="auto_recap_artifact_editor_body">
            <!-- Artifact Name -->
            <div class="auto_recap_form_group">
                <label for="auto_recap_artifact_editor_name">
                    <span>Artifact Name:</span>
                </label>
                <input id="auto_recap_artifact_editor_name" data-testid="artifact-editor-name" type="text" class="text_pole" placeholder="e.g., Detailed Recap v3" />
            </div>

            <!-- Description -->
            <div class="auto_recap_form_group">
                <label for="auto_recap_artifact_editor_description">
                    <span>Description:</span>
                    <small class="displayBlock opacity50p">(Optional)</small>
                </label>
                <input id="auto_recap_artifact_editor_description" data-testid="artifact-editor-description" type="text" class="text_pole" placeholder="Brief description of this config" />
            </div>

            <!-- Prompt -->
            <div class="auto_recap_form_group">
                <label for="auto_recap_artifact_editor_prompt">
                    <span>Prompt:</span>
                </label>
                <textarea id="auto_recap_artifact_editor_prompt" data-testid="artifact-editor-prompt" class="text_pole" rows="10" placeholder="Enter the prompt text here..."></textarea>
            </div>

            <!-- Macro Reference -->
            <div class="auto_recap_form_group">
                <details id="auto_recap_macro_reference" style="margin-bottom: 15px; padding: 10px; border: 1px solid rgba(255,255,255,0.1); border-radius: 5px; background: rgba(0,0,0,0.2);">
                    <summary style="cursor: pointer; font-weight: 600; user-select: none; display: flex; align-items: center; gap: 8px;">
                        <i class="fa-solid fa-code"></i>
                        <span>Available Macros</span>
                        <small class="opacity50p" style="font-weight: normal; margin-left: auto;">(Click to expand)</small>
                    </summary>
                    <div id="auto_recap_macro_reference_content" style="margin-top: 12px; max-height: 400px; overflow-y: auto; padding-right: 5px;">
                        <p class="opacity50p" style="margin: 0;">Loading macros...</p>
                    </div>
                </details>
            </div>

            <!-- Prefill -->
            <div class="auto_recap_form_group">
                <label for="auto_recap_artifact_editor_prefill">
                    <span>Prefill:</span>
                    <small class="displayBlock opacity50p">Text to prefill AI response (e.g., "{" for JSON)</small>
                </label>
                <input id="auto_recap_artifact_editor_prefill" data-testid="artifact-editor-prefill" type="text" class="text_pole" placeholder="{" />
            </div>

            <!-- Connection Profile -->
            <div class="auto_recap_form_group">
                <label for="auto_recap_artifact_editor_connection">
                    <span>Connection Profile:</span>
                    <small class="displayBlock opacity50p">Which API connection to use (empty = use current)</small>
                </label>
                <select id="auto_recap_artifact_editor_connection" data-testid="artifact-editor-connection" class="text_pole">
                    <option value="">Use Current Connection</option>
                </select>
            </div>

            <!-- Completion Preset -->
            <div class="auto_recap_form_group">
                <label for="auto_recap_artifact_editor_preset">
                    <span>Completion Preset:</span>
                    <small class="displayBlock opacity50p">Temperature/top_p settings (empty = use default)</small>
                </label>
                <select id="auto_recap_artifact_editor_preset" data-testid="artifact-editor-preset" class="text_pole">
                    <option value="">Use Default Preset</option>
                </select>
            </div>

            <!-- Include Preset Prompts -->
            <div class="auto_recap_form_group">
                <label class="checkbox_label" title="Include prompts from the completion preset (system prompts, jailbreak, etc.) before extension prompts">
                    <input id="auto_recap_artifact_editor_include_flag" data-testid="artifact-editor-include-flag" type="checkbox" />
                    <span>Include Preset Prompts</span>
                </label>
            </div>

            <!-- Forced Detection Settings Section (only for auto_scene_break) -->
            <div id="auto_recap_artifact_editor_forced_section" data-testid="artifact-editor-forced-section" style="display: none;">
                <hr>

                <!-- Forced Detection Settings -->
                <h4 style="margin: 15px 0 10px 0;">
                    <i class="fa-solid fa-bolt"></i> Forced Detection Settings
                    <i class="fa-solid fa-info-circle opacity50p" style="font-size: 0.85em; margin-left: 5px;" title="Used when context limits require a scene break to be selected (forceSelection=true)."></i>
                </h4>

            <!-- Forced Detection Prompt -->
            <div class="auto_recap_form_group">
                <label for="auto_recap_artifact_editor_forced_prompt">
                    <span>Forced Detection Prompt:</span>
                </label>
                <textarea id="auto_recap_artifact_editor_forced_prompt" data-testid="artifact-editor-forced-prompt" class="text_pole" rows="8"></textarea>
            </div>

            <!-- Forced Detection Prefill -->
            <div class="auto_recap_form_group">
                <label for="auto_recap_artifact_editor_forced_prefill">
                    <span>Forced Detection Prefill:</span>
                </label>
                <input id="auto_recap_artifact_editor_forced_prefill" data-testid="artifact-editor-forced-prefill" type="text" class="text_pole" />
            </div>

            <!-- Forced Detection Connection Profile -->
            <div class="auto_recap_form_group">
                <label for="auto_recap_artifact_editor_forced_connection">
                    <span>Forced Detection Connection Profile:</span>
                </label>
                <select id="auto_recap_artifact_editor_forced_connection" data-testid="artifact-editor-forced-connection" class="text_pole">
                    <option value=""></option>
                </select>
            </div>

            <!-- Forced Detection Completion Preset -->
            <div class="auto_recap_form_group">
                <label for="auto_recap_artifact_editor_forced_preset">
                    <span>Forced Detection Completion Preset:</span>
                </label>
                <select id="auto_recap_artifact_editor_forced_preset" data-testid="artifact-editor-forced-preset" class="text_pole">
                    <option value=""></option>
                </select>
            </div>

            <!-- Forced Detection Include Preset Prompts -->
            <div class="auto_recap_form_group">
                <label class="checkbox_label">
                    <input id="auto_recap_artifact_editor_forced_include_flag" data-testid="artifact-editor-forced-include-flag" type="checkbox" />
                    <span>Forced Detection: Include Preset Prompts</span>
                </label>
            </div>

                <hr>
            </div>
            <!-- End Forced Detection Settings Section -->

            <!-- Auto-save Warning -->
            <div class="note-block">
                <i class="fa-solid fa-exclamation-triangle"></i>
                <span><strong>Auto-save enabled:</strong> Changes are saved automatically with version increment on first edit.</span>
            </div>
        </div>

        <div class="auto_recap_artifact_editor_footer">
            <button id="auto_recap_artifact_editor_save" data-testid="artifact-editor-save" class="menu_button" title="Save and close">
                <i class="fa-solid fa-floppy-disk"></i> Save & Close
            </button>
            <button id="auto_recap_artifact_editor_cancel" data-testid="artifact-editor-cancel" class="menu_button" title="Discard changes and close">
                <i class="fa-solid fa-times"></i> Cancel
            </button>
        </div>
    </div>
</div>
