<div id="auto_recap_memory_settings" data-testid="extension-settings-panel" class="auto_recap_memory_settings_content">
    <div class="inline-drawer">

        <div class="inline-drawer-toggle inline-drawer-header">
            <div class="flex-container alignitemscenter margin0">
                <b>ST-Auto-Recap</b>
                <i id="auto_recap_popout_button" data-testid="extension-popout" class="fa-solid fa-window-restore menu_button margin0"></i>
            </div>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
        </div>

        <div class="inline-drawer-content">

            <!-- transferred to popup -->
            <div class="auto_recap_memory_settings_content">
                <hr>

                <div class="flex-container justifyspacebetween alignitemscenter">
                    <button id="toggle_chat_memory" data-testid="memory-toggle" class="menu_button flex2" title="Toggle whether memory is enabled for this chat specifically (overrides all settings)."><span>Toggle Memory</span></button>
                    <button id="refresh_memory" data-testid="memory-refresh" class="menu_button fa-solid fa-sync margin0" title="Just refreshes which memories are included and re-renders the memories under each message, doesn't change recaps. This is done automatically all the time, the button is here just in case."></button>
                </div>

                <hr>

                <div class="flex-container alignitemscenter margin0">
                    <h4 class="margin0">Configuration Profiles</h4>
                    <button id="import_profile" data-testid="profile-import" class="menu_button fa-solid fa-file-import" title="Import a config profile"></button>
                    <button id="export_profile" data-testid="profile-export" class="menu_button fa-solid fa-file-export" title="Export the current config profile"></button>
                    <input id="import_file" data-testid="profile-import-file" type="file" hidden="" accept=".json">
                </div>
                <div class="flex-container justifyspacebetween alignitemscenter">
                    <select id="profile" data-testid="profile-select" class="flex1 text_pole" title="The currently selected profile"></select>
                    <button id="rename_profile" data-testid="profile-rename" class="menu_button fa-solid fa-pencil interactable" title="Rename current profile" tabindex="0"></button>
                    <button id="new_profile" data-testid="profile-new" class="menu_button fa-solid fa-file-circle-plus interactable" title="Create new profile" tabindex="0"></button>
                    <button id="restore_profile" data-testid="profile-restore" class="menu_button fa-solid fa-recycle interactable" title="Restore current profile" tabindex="0"></button>
                    <button id="delete_profile" data-testid="profile-delete" class="menu_button fa-solid fa-trash-can interactable" title="Delete current profile" tabindex="0"></button>
                </div>
                <div class="flex-container justifyspacebetween alignitemscenter">
                    <button id="character_profile" data-testid="profile-character-autoload" class="menu_button interactable" title="Auto-load profile for current character" tabindex="0"><i class="fa-solid fa-unlock" style="margin-right: 1em"></i>Character</button>
                    <button id="chat_profile" data-testid="profile-chat-autoload" class="menu_button interactable" title="Auto-load profile for current chat" tabindex="0"><i class="fa-solid fa-unlock" style="margin-right: 1em"></i>Chat</button>
                    <label class="checkbox_label" title="Show a notification upon switching profiles">
                        <input id="notify_on_profile_switch" data-testid="profile-notify-switch" type="checkbox" />
                        <span>Notify on Switch</span>
                    </label>
                </div>

                <!-- First-Hop Proxy Integration -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">First-Hop Proxy Integration <i class="fa-solid fa-info-circle" title="Add metadata to LLM requests for downstream proxy logging and tracking."></i></h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <label title="Send chat details (chat name/ID) in LLM requests for proxy logging." class="checkbox_label">
                            <input id="first_hop_proxy_send_chat_details" data-testid="proxy-send-chat-details" type="checkbox" />
                            <span>Send Chat Details</span>
                        </label>

                        <label title="When enabled, suppress global/character/persona lorebooks during generation (only chat lorebooks will be included). This prevents conflicts between auto-generated lorebooks and manually-created ones." class="checkbox_label">
                            <input id="suppress_other_lorebooks" data-testid="proxy-suppress-other-lorebooks" type="checkbox" />
                            <span>Suppress Non-Chat Lorebooks</span>
                        </label>

                        <div class="note-block">
                            <i class="fa-solid fa-info-circle"></i>
                            <span>When enabled, metadata is added to LLM requests that your proxy can parse and strip before forwarding to the LLM. This allows your proxy to log requests with chat context.</span>
                        </div>
                    </div>
                </div>

                <!-- General Injection Settings -->
                <!-- Message Filtering -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Message Filtering <i class="fa-solid fa-info-circle" title="Controls which messages are included in scene recaps and other features."></i></h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <label title="Include user messages in scene recaps and other features." class="checkbox_label">
                            <input id="include_user_messages" data-testid="filter-include-user" type="checkbox" />
                            <span>Include User Messages</span>
                        </label>

                        <label title="Include hidden messages in scene recaps and other features (messages excluded from context)." class="checkbox_label">
                            <input id="include_system_messages" data-testid="filter-include-hidden" type="checkbox" />
                            <span>Include Hidden Messages</span>
                        </label>

                        <label title="Include system messages in scene recaps and other features (e.g. messages from the /sys command)." class="checkbox_label">
                            <input id="include_narrator_messages" data-testid="filter-include-system" type="checkbox" />
                            <span>Include System Messages</span>
                        </label>

                        <label title="The minimum token length a message has to be in order to be included.">
                            <input id="message_length_threshold" data-testid="filter-message-length" class="text_pole widthUnset inline_setting" type="number" min="0" max="999" />
                            <span>Message Length Threshold</span>
                        </label>
                    </div>
                </div>

                <!-- Scene Recap -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Scene Recap <i class="fa-solid fa-info-circle" title="Recap each scene break and use the results to build the running scene recap."></i></h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <label title="Width of the scene navigator bar in pixels.">
                            <span>Navigator Bar Width (pixels):</span>
                            <input id="scene_recap_navigator_width" data-testid="scene-nav-width" class="text_pole" type="number" min="30" max="500" step="1" />
                        </label>
                        <label title="Font size for scene names in the navigator bar (in pixels).">
                            <span>Navigator Font Size (pixels):</span>
                            <input id="scene_recap_navigator_font_size" data-testid="scene-nav-font-size" class="text_pole" type="number" min="8" max="24" step="1" />
                        </label>
                        <!-- Standalone scene-name auto-generation removed. Scene name is part of the recap output. -->
                        <label class="checkbox_label" title="New scene recaps will start collapsed by default (showing only the scene name). Existing scenes keep their current state.">
                            <input id="scene_recap_default_collapsed" data-testid="scene-default-collapsed" type="checkbox" />
                            <span>Collapse New Scenes by Default</span>
                        </label>
                        <div class="flex-container justifyspacebetween alignitemscenter">
                            <button id="edit_scene_recap_prompt" data-testid="scene-edit-prompt" class="menu_button flex1" title="Edit the scene recap prompt"><span>Edit Scene Prompt</span></button>
                        </div>
                        <input id="scene_recap_prompt" data-testid="scene-prompt" type="hidden" />
                        <input id="scene_recap_default_prompt" data-testid="scene-default-prompt" type="hidden" value="[Default scene recap prompt here]" />
                        <table>
                            <tr>
                                <td><span>Scene Connection Profile</span></td>
                                <td><select id="scene_recap_connection_profile" data-testid="scene-connection-profile" class="text_pole"></select></td>
                            </tr>
                            <tr>
                                <td></td>
                                <td>
                                    <label class="checkbox_label" title="Include prompts from the completion preset (system prompts, jailbreak, etc.) before extension prompts">
                                        <input id="scene_recap_include_preset_prompts" data-testid="scene-include-preset-prompts" type="checkbox" />
                                        <span>Include Preset Prompts</span>
                                    </label>
                                </td>
                            </tr>
                            <tr>
                                <td></td>
                                <td>
                                    <label class="checkbox_label" title="Include active lorebook entries in the scene recap prompt to provide context. Only new or changed information from lorebooks will be included.">
                                        <input id="scene_recap_include_active_setting_lore" data-testid="scene-include-active-setting-lore" type="checkbox" />
                                        <span>Include Active setting_lore Entries</span>
                                    </label>
                                </td>
                            </tr>
                            <tr>
                                <td><span>Scene Completion Preset</span></td>
                                <td><select id="scene_recap_completion_preset" data-testid="scene-completion-preset" class="text_pole"></select></td>
                            </tr>
                            <tr>
                                <td><span>Scene Recap Prefill</span></td>
                                <td><input id="scene_recap_prefill" data-testid="scene-prefill" class="text_pole" type="text" placeholder="Start reply with..."></td>
                            </tr>
                            <tr>
                                <td><span>Include Message Types</span></td>
                                <td>
                                    <select id="scene_recap_message_types" data-testid="scene-message-types" class="text_pole">
                                        <option value="user">User Messages Only</option>
                                        <option value="character">AI Messages Only</option>
                                        <option value="both">All Messages</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <span>Recap the last <span id="scene_recap_history_count_display" data-testid="scene-history-count-display">1</span> scenes</span>
                                </td>
                                <td>
                                    <input id="scene_recap_history_count" data-testid="scene-history-count" class="text_pole" type="number" min="1" max="99" value="1" />
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Running Scene Recap -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Running Scene Recap <i class="fa-solid fa-info-circle" title="Combine multiple scene recaps into a single cohesive memory. This is the recommended default behavior matching best practices."></i></h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <label title="Number of latest scene recaps to exclude from the running recap. Default: 1 (allows you to validate the latest scene recap before it's combined).">
                            <span>Exclude Latest <span id="running_scene_recap_exclude_latest_display" data-testid="running-exclude-latest-display">1</span> Scene(s)</span>
                            <input id="running_scene_recap_exclude_latest" data-testid="running-exclude-latest" class="text_pole" type="range" min="0" max="5" step="1" value="1" />
                        </label>
                        <small style="display:block; margin-bottom:0.5em;">Recommended: 1 (exclude latest scene to allow manual validation before combining)</small>

                        <label class="checkbox_label" title="Automatically generate running scene recap when new scene recaps are created.">
                            <input id="running_scene_recap_auto_generate" data-testid="running-auto-generate" type="checkbox" />
                            <span>Auto-generate on New Scene Recaps</span>
                        </label>

                        <label class="checkbox_label" title="Show version control buttons in the navbar to switch between, edit, or delete running recap versions.">
                            <input id="running_scene_recap_show_navbar" data-testid="running-show-navbar" type="checkbox" />
                            <span>Show Navbar Version Controls</span>
                        </label>

                        <div class="flex-container justifyspacebetween alignitemscenter">
                            <button id="view_running_scene_recap" data-testid="running-view" class="menu_button flex2" title="View/edit the current running scene recap"><span>View Running Recap</span></button>
                            <button id="edit_running_scene_recap_prompt" data-testid="running-edit-prompt" class="menu_button flex1" title="Edit the running scene recap prompt"><span>Edit Running Recap Prompt</span></button>
                        </div>
                        <input id="running_scene_recap_prompt" data-testid="running-prompt" type="hidden" />

                        <table>
                            <tr>
                                <td><span>Running Recap Connection Profile</span></td>
                                <td><select id="running_scene_recap_connection_profile" data-testid="running-connection-profile" class="text_pole"></select></td>
                            </tr>
                            <tr>
                                <td></td>
                                <td>
                                    <label class="checkbox_label" title="Include prompts from the completion preset (system prompts, jailbreak, etc.) before extension prompts">
                                        <input id="running_scene_recap_include_preset_prompts" data-testid="running-include-preset-prompts" type="checkbox" />
                                        <span>Include Preset Prompts</span>
                                    </label>
                                </td>
                            </tr>
                            <tr>
                                <td><span>Running Recap Completion Preset</span></td>
                                <td><select id="running_scene_recap_completion_preset" data-testid="running-completion-preset" class="text_pole"></select></td>
                            </tr>
                            <tr>
                                <td><span>Running Recap Prefill</span></td>
                                <td><input id="running_scene_recap_prefill" data-testid="running-prefill" class="text_pole" type="text" placeholder="Start reply with..."></td>
                            </tr>
                        </table>

                        <label title="Where to inject the running scene recap.">
                            <select id="running_scene_recap_position" data-testid="running-position" class="text_pole">
                                <option value="-1">Do not inject</option>
                                <option value="2">Before main prompt</option>
                                <option value="0">After main prompt</option>
                                <option value="1">In chat at depth</option>
                            </select>
                        </label>
                        <label title="Depth for in-chat injection.">
                            <input id="running_scene_recap_depth" data-testid="running-depth" class="text_pole inline_setting" type="number" min="0" max="99" />
                            <span>Depth</span>
                        </label>
                        <label title="Role for in-chat injection.">
                            <select id="running_scene_recap_role" data-testid="running-role" class="text_pole inline_setting">
                                <option value="0">System</option>
                                <option value="1">User</option>
                                <option value="2">Assistant</option>
                            </select>
                        </label>
                        <label class="checkbox_label" title="Include in World Info Scanning">
                            <input id="running_scene_recap_scan" data-testid="running-scan" type="checkbox" />
                            <span>Include in World Info Scanning</span>
                        </label>
                    </div>
                </div>

                <!-- Auto Scene Break Detection -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Auto Scene Break Detection <i class="fa-solid fa-info-circle" title="Automatically detect and mark scene breaks using AI analysis."></i></h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <!-- Removed master enable toggle: scene break detection is always available.
                             Behavior is governed by per-event options and manual run. -->
                        <label class="checkbox_label" title="Automatically check for scene breaks when chat loads.">
                            <input id="auto_scene_break_on_load" data-testid="auto-scene-on-load" type="checkbox" />
                            <span>Auto-check on Chat Load</span>
                        </label>
                        <label class="checkbox_label" title="Automatically check for scene breaks when new messages arrive.">
                            <input id="auto_scene_break_on_new_message" data-testid="auto-scene-on-message" type="checkbox" />
                            <span>Auto-check on New Messages</span>
                        </label>
                        <label class="checkbox_label" title="Automatically generate a scene recap when a scene break is detected. The recap generation will complete before checking the next message.">
                            <input id="auto_scene_break_generate_recap" data-testid="auto-scene-generate-recap" type="checkbox" />
                            <span>Auto-generate Scene Recap on Detection</span>
                        </label>

                        <label title="How many messages back from the latest to skip checking. 0 = check all including latest, 1 = skip latest, 2 = skip 2 latest, etc.">
                            <span>Message Offset (skip latest N messages): <span id="auto_scene_break_message_offset_value" data-testid="auto-scene-offset-display">2</span></span>
                            <input id="auto_scene_break_message_offset" data-testid="auto-scene-message-offset" class="text_pole" type="range" min="0" max="10" step="1" value="2" />
                        </label>
                        <small style="display:block; margin-bottom:0.5em;">Recommended: 2 (skip 2 latest messages to allow for swipes/regeneration)</small>

                        <label title="Which message types to check for scene breaks.">
                            <span>Check Which Messages:</span>
                            <select id="auto_scene_break_check_which_messages" data-testid="auto-scene-check-which" class="text_pole">
                                <option value="character">AI Messages Only</option>
                                <option value="user">User Messages Only</option>
                                <option value="both">Both User and AI Messages</option>
                            </select>
                        </label>
                        <small style="display:block; margin-bottom:0.5em;">Scene breaks typically occur in AI responses, but some users write them in their inputs too.</small>

                        <label title="Minimum number of filtered messages required before allowing the LLM to choose a scene break point. This prevents breaking too early in a scene.">
                            <span>Minimum Scene Length: <span id="auto_scene_break_minimum_scene_length_value" data-testid="auto-scene-min-length-display">4</span> messages</span>
                            <input id="auto_scene_break_minimum_scene_length" data-testid="auto-scene-min-length" class="text_pole" type="number" min="1" max="50" step="1" value="4" />
                        </label>
                        <small style="display:block; margin-bottom:0.5em;">Counts only messages matching the selected message type filter above.</small>

                        <div class="flex-container justifyspacebetween alignitemscenter">
                            <button id="edit_auto_scene_break_prompt" data-testid="auto-scene-edit-prompt" class="menu_button flex1" title="Edit the auto scene break detection prompt"><span>Edit Detection Prompt</span></button>
                        </div>

                        <input id="auto_scene_break_prompt" data-testid="auto-scene-prompt" type="hidden" />

                        <table>
                            <tr title="The connection profile to use for scene break detection. Leave empty to use current profile.">
                                <td><span>Detection Connection Profile</span></td>
                                <td><select id="auto_scene_break_connection_profile" data-testid="auto-scene-connection-profile" class="text_pole"></select></td>
                            </tr>
                            <tr>
                                <td></td>
                                <td>
                                    <label class="checkbox_label" title="Include prompts from the completion preset (system prompts, jailbreak, etc.) before extension prompts">
                                        <input id="auto_scene_break_include_preset_prompts" data-testid="auto-scene-include-preset-prompts" type="checkbox" />
                                        <span>Include Preset Prompts</span>
                                    </label>
                                </td>
                            </tr>
                            <tr title="The completion preset to use for scene break detection. Leave empty to use current preset.">
                                <td><span>Detection Completion Preset</span></td>
                                <td><select id="auto_scene_break_completion_preset" data-testid="auto-scene-completion-preset" class="text_pole"></select></td>
                            </tr>
                            <tr title="Start the detection with this prefilled text to enforce true/false output.">
                                <td><span>Detection Prefill</span></td>
                                <td><input id="auto_scene_break_prefill" data-testid="auto-scene-prefill" class="text_pole" type="text" placeholder=""></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Error Detection -->
                <hr>
                <div class="inline-drawer" style="display: none;">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Recap Validation <i class="fa-solid fa-info-circle" title="Configure validation for recaps to ensure they meet your criteria"></i></h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <label class="checkbox_label" title="Enable two-step validation for recaps">
                            <input id="error_detection_enabled" data-testid="validation-enabled" type="checkbox" />
                            <span>Enable Recap Validation</span>
                        </label>

                <!-- Scene recap validation -->
                <label class="checkbox_label error_detection_setting" title="Enable validation for scene recaps">
                    <input id="scene_recap_error_detection_enabled" data-testid="validation-scene-enabled" type="checkbox" />
                    <span>Validate Scene Recaps</span>
                </label>
                <div class="flex-container justifyspacebetween alignitemscenter">
                    <button id="edit_scene_recap_error_detection_prompt" data-testid="validation-scene-edit-prompt" class="menu_button flex1 error_detection_setting" title="Edit the validation prompt for scene recaps"><span>Edit Scene Recap Validation Prompt</span></button>
                </div>
                <table class="scene_error_detection_container">
                    <tr>
                        <td></td>
                        <td>
                            <label class="checkbox_label scene_error_detection_setting" title="Include prompts from the completion preset (system prompts, jailbreak, etc.) before extension prompts">
                                <input id="scene_recap_error_detection_include_preset_prompts" data-testid="validation-scene-include-preset-prompts" type="checkbox" class="scene_error_detection_setting" />
                                <span>Include Preset Prompts</span>
                            </label>
                        </td>
                    </tr>
                    <tr>
                        <td><span>Scene Recap Validation Preset</span></td>
                        <td><select id="scene_recap_error_detection_preset" data-testid="validation-scene-preset" class="text_pole scene_error_detection_setting"></select></td>
                    </tr>
                    <tr>
                        <td><span>Scene Recap Validation Prefill</span></td>
                        <td><input id="scene_recap_error_detection_prefill" data-testid="validation-scene-prefill" class="text_pole scene_error_detection_setting" type="text" placeholder="Start reply with..."></td>
                    </tr>
                    <tr>
                        <td><span>Scene Recap Max Retry Attempts</span></td>
                        <td><input id="scene_recap_error_detection_retries" data-testid="validation-scene-retries" class="text_pole scene_error_detection_setting" type="number" min="1" max="10" value="3"></td>
                    </tr>
                </table>
                <input id="scene_recap_error_detection_prompt" data-testid="validation-scene-prompt" type="hidden" />
                    </div>
                </div>

                <!-- Auto-Hide -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Auto-Hide</h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <label title="Automatically hide all messages in scenes older than this many scenes (set -1 to disable)" class="checkbox_label">
                            <span>Auto Hide Messages Older Than The Last</span>
                            <input id="auto_hide_scene_count" data-testid="auto-hide-scene-count" class="text_pole widthUnset inline_setting" type="number" min="-1" max="999" />
                            <span>Scene(s) (-1 to disable)</span>
                        </label>
                    </div>
                </div>

                <!-- Misc. -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Misc.</h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <label title="Whether recap is enabled by default for new chats." class="checkbox_label">
                            <input id="default_chat_enabled" data-testid="misc-default-enabled" type="checkbox" />
                            <span>Enable Recap in New Chats</span>
                        </label>

                        <label title="Uses a global on/off state shared between all chats with this enabled. When unchecked, turning the extension on/off only applies to active chat." class="checkbox_label">
                            <input id="use_global_toggle_state" data-testid="misc-global-toggle" type="checkbox" />
                            <span>Use Global Toggle State</span>
                        </label>
                    </div>
                </div>

                <!-- Auto-Lorebooks Settings -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Auto-Lorebooks</h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <div class="margin-bot-10px">
                            <label class="checkbox_label" for="autolorebooks-delete-on-chat-delete">
                                <input type="checkbox" id="autolorebooks-delete-on-chat-delete" data-testid="lorebook-delete-on-chat" />
                                <span>Delete lorebook when chat is deleted</span>
                            </label>
                        </div>

                        <div class="margin-bot-10px">
                            <label class="checkbox_label" for="autolorebooks-auto-reorder-alphabetically">
                                <input type="checkbox" id="autolorebooks-auto-reorder-alphabetically" data-testid="lorebook-auto-reorder" />
                                <span>Auto-reorder entries alphabetically when created or renamed</span>
                            </label>
                        </div>

                        <div class="margin-bot-10px">
                            <label for="autolorebooks-name-template">
                                <span>Lorebook naming template:</span>
                                <small class="displayBlock opacity50p">Available variables: {{char}}, {{chat}}</small>
                            </label>
                            <input type="text" id="autolorebooks-name-template" data-testid="lorebook-name-template" class="text_pole" placeholder="z-AutoLB-{{chat}}" />
                        </div>
                        <div class="margin-bot-10px">
                            <label>
                                <span>Supported lorebook entry types:</span>
                                <small class="displayBlock opacity50p">Applies to the {{lorebook_entry_types}} macro and registry generation. Values should be lowercase slugs.</small>
                            </label>
                            <div id="autolorebooks-entity-types-list" data-testid="lorebook-entity-types-list" class="margin-top-5px"></div>
                            <div class="flex-container alignitemscenter margin-top-5px" style="gap: 5px;">
                                <input type="text" id="autolorebooks-entity-type-input" data-testid="lorebook-entity-type-input" class="text_pole" placeholder="e.g. quest(entry:constant)" />
                                <button id="autolorebooks-add-entity-type" data-testid="lorebook-add-entity-type" class="menu_button">Add</button>
                                <button id="autolorebooks-restore-entity-types" data-testid="lorebook-restore-entity-types" class="menu_button fa-solid fa-recycle" title="Restore default types"></button>
                            </div>
                        </div>

                        <hr>

                        <h4>Recap-to-Lorebook Processing</h4>

                        <div class="margin-bot-10px">
                            <label class="checkbox_label" for="autolorebooks-recap-skip-duplicates">
                                <input type="checkbox" id="autolorebooks-recap-skip-duplicates" data-testid="lorebook-skip-duplicates" />
                                <span>Skip already processed recaps</span>
                            </label>
                        </div>

                        <div class="inline-drawer margin-top-10px">
                            <div class="inline-drawer-toggle inline-drawer-header">
                                <div class="flex-container alignitemscenter margin0">
                                    <span>Default Entry Properties (for new entries from recaps)</span>
                                </div>
                                <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                            </div>
                            <div class="inline-drawer-content">
                                <div class="margin-bot-10px">
                                    <label class="checkbox_label" for="autolorebooks-entry-exclude-recursion">
                                        <input type="checkbox" id="autolorebooks-entry-exclude-recursion" data-testid="lorebook-entry-exclude-recursion" />
                                        <span>Exclude Recursion (Non-recursable)</span>
                                    </label>
                                    <small class="displayBlock opacity50p">When checked, this entry will not trigger other entries recursively</small>
                                </div>

                                <div class="margin-bot-10px">
                                    <label class="checkbox_label" for="autolorebooks-entry-prevent-recursion">
                                        <input type="checkbox" id="autolorebooks-entry-prevent-recursion" data-testid="lorebook-entry-prevent-recursion" />
                                        <span>Prevent Further Recursion</span>
                                    </label>
                                    <small class="displayBlock opacity50p">When checked, this entry will not activate other entries recursively</small>
                                </div>

                                <div class="margin-bot-10px">
                                    <label class="checkbox_label" for="autolorebooks-entry-ignore-budget">
                                        <input type="checkbox" id="autolorebooks-entry-ignore-budget" data-testid="lorebook-entry-ignore-budget" />
                                        <span>Ignore Budget</span>
                                    </label>
                                    <small class="displayBlock opacity50p">When checked, this entry will be included ignoring budget constraints</small>
                                </div>

                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-entry-sticky">
                                        <span>Sticky (rounds):</span>
                                        <small class="displayBlock opacity50p">Number of message rounds to keep entry active</small>
                                    </label>
                                    <input type="number" id="autolorebooks-entry-sticky" data-testid="lorebook-entry-sticky" class="text_pole" min="0" max="10000" />
                                </div>
                            </div>
                        </div>

                        <div class="inline-drawer margin-top-10px">
                            <div class="inline-drawer-toggle inline-drawer-header">
                                <div class="flex-container alignitemscenter margin0">
                                    <span>Entry Merge Settings (When Processing Recaps)</span>
                                </div>
                                <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                            </div>
                            <div class="inline-drawer-content">
                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-recap-merge-connection">
                                        <span>Connection Profile:</span>
                                        <small class="displayBlock opacity50p">Which API to use for merging lorebook entries (empty = use main API)</small>
                                    </label>
                                    <select id="autolorebooks-recap-merge-connection" data-testid="lorebook-merge-connection" class="text_pole">
                                        <option value="">Main API</option>
                                    </select>
                                </div>

                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-recap-merge-preset">
                                        <span>Completion Preset:</span>
                                        <small class="displayBlock opacity50p">Preset to use for merging entries (empty = use default)</small>
                                    </label>
                                    <select id="autolorebooks-recap-merge-preset" data-testid="lorebook-merge-preset" class="text_pole">
                                        <option value="">Default</option>
                                    </select>
                                    <label class="checkbox_label" title="Include prompts from the completion preset (system prompts, jailbreak, etc.) before extension prompts">
                                        <input id="auto_lorebooks_recap_merge_include_preset_prompts" data-testid="lorebook-merge-include-preset-prompts" type="checkbox" />
                                        <span>Include Preset Prompts</span>
                                    </label>
                                </div>

                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-recap-merge-prefill">
                                        <span>Prefill (Claude models):</span>
                                        <small class="displayBlock opacity50p">Text to prefill AI response</small>
                                    </label>
                                    <input type="text" id="autolorebooks-recap-merge-prefill" data-testid="lorebook-merge-prefill" class="text_pole" placeholder="" />
                                </div>

                                <div class="margin-bot-10px">
                                    <label>
                                        <span>Lorebook entry merge prompt:</span>
                                    </label>
                                    <div class="flex-container justifyspacebetween alignitemscenter">
                                        <button id="edit_autolorebooks_recap_merge_prompt" data-testid="lorebook-edit-merge-prompt" class="menu_button flex1" title="Edit the lorebook entry merge prompt"><span>Edit Merge Prompt</span></button>
                                    </div>
                                    <input id="autolorebooks-recap-merge-prompt" data-testid="lorebook-merge-prompt" type="hidden" />
                                </div>
                            </div>
                        </div>

                        <div class="inline-drawer margin-top-10px">
                            <div class="inline-drawer-toggle inline-drawer-header">
                                <div class="flex-container alignitemscenter margin0">
                                    <span>Duplicate Detection Settings</span>
                                </div>
                                <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                            </div>
                            <div class="inline-drawer-content">
                                <h5 class="margin-top-0">Stage 1 – Registry Lorebook Entry Lookup</h5>
                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-recap-lorebook-entry-lookup-connection">
                                        <span>Connection Profile:</span>
                                        <small class="displayBlock opacity50p">API profile to use when screening new entries (empty = use main API)</small>
                                    </label>
                                    <select id="autolorebooks-recap-lorebook-entry-lookup-connection" data-testid="lorebook-lookup-connection" class="text_pole">
                                        <option value="">Main API</option>
                                    </select>
                                </div>
                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-recap-lorebook-entry-lookup-preset">
                                        <span>Completion Preset:</span>
                                        <small class="displayBlock opacity50p">Preset for triage calls (empty = use default)</small>
                                    </label>
                                    <select id="autolorebooks-recap-lorebook-entry-lookup-preset" data-testid="lorebook-lookup-preset" class="text_pole">
                                        <option value="">Default</option>
                                    </select>
                                    <label class="checkbox_label" title="Include prompts from the completion preset (system prompts, jailbreak, etc.) before extension prompts">
                                        <input id="auto_lorebooks_recap_lorebook_entry_lookup_include_preset_prompts" data-testid="lorebook-lookup-include-preset-prompts" type="checkbox" />
                                        <span>Include Preset Prompts</span>
                                    </label>
                                </div>
                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-recap-lorebook-entry-lookup-prefill">
                                        <span>Prefill (Claude models):</span>
                                        <small class="displayBlock opacity50p">Optional text to prefill AI responses during triage</small>
                                    </label>
                                    <input type="text" id="autolorebooks-recap-lorebook-entry-lookup-prefill" data-testid="lorebook-lookup-prefill" class="text_pole" placeholder="" />
                                </div>
                                <div class="margin-bot-10px">
                                    <label>
                                        <span>Lorebook Entry Lookup prompt:</span>
                                    </label>
                                    <div class="flex-container justifyspacebetween alignitemscenter">
                                        <button id="edit_autolorebooks_recap_lorebook_entry_lookup_prompt" data-testid="lorebook-edit-lookup-prompt" class="menu_button flex1" title="Edit the lorebook entry lookup prompt"><span>Edit Lookup Prompt</span></button>
                                    </div>
                                    <input id="autolorebooks-recap-lorebook-entry-lookup-prompt" data-testid="lorebook-lookup-prompt" type="hidden" />
                                </div>

                                <h5>Stage 2 – Full LorebookEntryDeduplicate</h5>
                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-recap-entry-deduplicate-connection">
                                        <span>Connection Profile:</span>
                                        <small class="displayBlock opacity50p">API profile when comparing full entries (empty = use main API)</small>
                                    </label>
                                    <select id="autolorebooks-recap-entry-deduplicate-connection" data-testid="lorebook-dedupe-connection" class="text_pole">
                                        <option value="">Main API</option>
                                    </select>
                                </div>
                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-recap-entry-deduplicate-preset">
                                        <span>Completion Preset:</span>
                                        <small class="displayBlock opacity50p">Preset for the follow-up comparison call (empty = use default)</small>
                                    </label>
                                    <select id="autolorebooks-recap-entry-deduplicate-preset" data-testid="lorebook-dedupe-preset" class="text_pole">
                                        <option value="">Default</option>
                                    </select>
                                    <label class="checkbox_label" title="Include prompts from the completion preset (system prompts, jailbreak, etc.) before extension prompts">
                                        <input id="auto_lorebooks_recap_lorebook_entry_deduplicate_include_preset_prompts" data-testid="lorebook-dedupe-include-preset-prompts" type="checkbox" />
                                        <span>Include Preset Prompts</span>
                                    </label>
                                </div>
                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-recap-entry-deduplicate-prefill">
                                        <span>Prefill (Claude models):</span>
                                        <small class="displayBlock opacity50p">Optional text to prefill the comparison response</small>
                                    </label>
                                    <input type="text" id="autolorebooks-recap-entry-deduplicate-prefill" data-testid="lorebook-dedupe-prefill" class="text_pole" placeholder="" />
                                </div>
                                <div class="margin-bot-10px">
                                    <label>
                                        <span>LorebookEntryDeduplicate prompt:</span>
                                    </label>
                                    <div class="flex-container justifyspacebetween alignitemscenter">
                                        <button id="edit_autolorebooks_recap_entry_deduplicate_prompt" data-testid="lorebook-edit-dedupe-prompt" class="menu_button flex1" title="Edit the lorebook entry deduplicate prompt"><span>Edit Dedupe Prompt</span></button>
                                    </div>
                                    <input id="autolorebooks-recap-entry-deduplicate-prompt" data-testid="lorebook-dedupe-prompt" type="hidden" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>
                <div class="flex-container justifyspacebetween alignitemscenter">
                    <button id="revert_settings" data-testid="settings-restore-defaults" class="menu_button flex1 margin0" title="Restore all settings to their default values. This completely resets all configuration options to factory defaults. Your saved profiles won't be affected.">
                        <span>Restore All Defaults</span>
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>
