<div id="auto_summarize_memory_settings" class="auto_summarize_memory_settings_content">
    <div class="inline-drawer">

        <div class="inline-drawer-toggle inline-drawer-header">
            <div class="flex-container alignitemscenter margin0">
                <b>auto_summarize Memory</b>
                <i id="auto_summarize_popout_button" class="fa-solid fa-window-restore menu_button margin0"></i>
            </div>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
        </div>

        <div class="inline-drawer-content">

            <!-- transferred to popup -->
            <div class="auto_summarize_memory_settings_content">
                <hr>

                <div class="flex-container justifyspacebetween alignitemscenter">
                    <button id="toggle_chat_memory" class="menu_button flex2" title="Toggle whether memory is enabled for this chat specifically (overrides all settings)."><span>Toggle Memory</span></button>
                    <button id="edit_memory_state" class="menu_button flex2" title="Edit the memories in chat."><span>Edit Memory</span></button>
                    <button id="view_combined_summary" class="menu_button flex2" title="View the current combined summary"><span>View Combined Summary</span></button>
                    <button id="refresh_memory" class="menu_button fa-solid fa-sync margin0" title="Just refreshes which memories are included and re-renders the memories under each message, doesn't change summaries. This is done automatically all the time, the button is here just in case."></button>
                </div>

                <hr>

                <div>
                    <div class="flex-container justifyspacebetween alignitemscenter" style="margin: auto; width: fit-content;">
                        <h4 class="textAlignCenter">Configuration Profiles</h4>
                        <button id="import_profile"     class="menu_button fa-solid fa-file-import"    title="Import a config profile"></button>
                        <button id="export_profile"     class="menu_button fa-solid fa-file-export"    title="Export the current config profile"></button>
                        <input id="import_file" type="file" hidden="" accept=".json">
                    </div>
                </div>

                <div class="flex-container justifyspacebetween alignitemscenter">
                    <select id="profile"            class="flex1 text_pole"                                 title="The currently selected profile"></select>
                    <button id="save_profile"       class="menu_button fa-solid fa-save interactable"       title="Save current profile" tabindex="0"></button>
                    <button id="rename_profile"     class="menu_button fa-solid fa-pencil interactable"     title="Rename current profile" tabindex="0"></button>
                    <button id="new_profile"        class="menu_button fa-solid fa-file-circle-plus interactable" title="Create new profile" tabindex="0"></button>
                    <button id="restore_profile"    class="menu_button fa-solid fa-recycle interactable"    title="Restore current profile" tabindex="0"></button>
                    <button id="delete_profile"     class="menu_button fa-solid fa-trash-can interactable"  title="Delete current profile" tabindex="0"></button>
                </div>
                <div class="flex-container justifyspacebetween alignitemscenter">
                    <button id="character_profile" class="menu_button interactable" title="Auto-load profile for current character" tabindex="0"><i class="fa-solid fa-unlock" style="margin-right: 1em"></i>Character</button>
                    <button id="chat_profile"      class="menu_button interactable" title="Auto-load profile for current chat"      tabindex="0"><i class="fa-solid fa-unlock" style="margin-right: 1em"></i>Chat</button>
                    <label class="checkbox_label" title="Show a notification upon switching profiles">
                        <input id="notify_on_profile_switch" type="checkbox" />
                        <span>Notify on Switch</span>
                    </label>
                </div>


                <!-- Summarization -->
                <hr>
                <h4 class="textAlignCenter">Summarization <i class="fa-solid fa-info-circle" title="Customize the prompt used to summarize a given message"></i></h4>
                <div class="flex-container justifyspacebetween alignitemscenter">
                    <button id="edit_summary_prompt" class="menu_button flex1" title="Edit the summary prompt" >Edit Summary Prompt</button>
                    <button id="preview_summary_prompt" class="menu_button fa-solid fa-eye" title="Preview the filled-in summary prompt, using the last message as an example." ></button>
                    <button id="stop_summarization" class="menu_button fa-solid fa-stop" title="Stop all summarization immediately."></button>
                </div>

                <table>

                    <tr title="The connection profile to use for summaries. Note that choosing a different profile will require temporarily switching to the profile during summarization, discarding any unsaved changes to the current profile.">
                        <td><span>Connection Profile</span></td>
                        <td><select id="connection_profile" class="text_pole"></select></td>
                    </tr>

                    <tr title="The completion preset to use for summaries. Note that choosing a different preset will require temporarily switching to that preset during summarization, discarding any unsaved changes to the current preset. Also be aware that presets are not shared between connection APIs.">
                        <td><span>Completion Preset</span></td>
                        <td><select id="completion_preset" class="text_pole"></select></td>
                    </tr>

                    <tr title="Start the summarization with this prefilled text.">
                        <td><span>Summary Prefill</span></td>
                        <td><input id="prefill" class="text_pole" type="text" placeholder="Start reply with..."></td>
                    </tr>

                </table>

                <label title="Include the prefill in displayed memories and injections (no effect with reasoning models)" class="checkbox_label">
                    <input id="show_prefill" type="checkbox" />
                    <span>Include Prefill In Memories</span>
                </label>

                <hr>

                <label class="checkbox_label" title="New messages will be automatically summarized if they will be included in short-term memory.">
                    <input id="auto_summarize" type="checkbox" />
                    <span>Auto Summarize</span>
                </label>

                <label class="checkbox_label" title="Auto-summarization will be triggered before a new message is sent instead of after.">
                    <input id="auto_summarize_on_send" type="checkbox" />
                    <span>Auto Summarize Before Generation</span>
                </label>

                <label title="Show the progress bar when auto-summarizing more than 1 message." class="checkbox_label">
                    <input id="auto_summarize_progress" type="checkbox" />
                    <span>Auto Summarize Progress Bar</span>
                </label>

                <label class="checkbox_label" title="Number of messages to wait before auto-summarizing a message (0 = summarize up to the most recent message, 1 = wait one message, etc.)">
                    <input id="summarization_delay" class="text_pole widthUnset inline_setting" type="number" min="0" max="999" />
                    <span>Auto Summarize Message Lag</span>
                </label>

                <label class="checkbox_label" title="Wait until this many messages before auto-summarizing them all in sequence (1 = summarize every message immediately, 2 = summarize when you have two ready, etc). Still summarizes one at a time. ">
                    <input id="auto_summarize_batch_size" class="text_pole widthUnset inline_setting" type="number" min="1" max="999" />
                    <span>Auto Summarize Batch Size</span>
                </label>

                <label class="checkbox_label" title="The maximum amount of lookback when checking for messages to summarize (-1 to disable). For example, 10 means that when auto-summarizing, the 10 most recent valid summarization targets will be checked, and those without summaries will be summarized.">
                    <input id="auto_summarize_message_limit" class="text_pole widthUnset inline_setting" type="number" min="-1" max="999" />
                    <span>Auto Summarize Message Limit</span>
                </label>

                <hr>

                <div class="flex-container justifyspacebetween">
                    <label title="Whether to use messages and/or summaries as context for summarization. You must use {{history}} in the summary prompt. Summaries will follow configured inclusion criteria." class="checkbox_label">
                        <span>Message History </span>
                        <select id="include_message_history_mode" class="text_pole flex2">
                            <option value="none">None</option>
                            <option value="messages_only">Messages</option>
                            <option value="summaries_only">Summaries</option>
                            <option value="messages_and_summaries">Both</option>
                        </select>
                    </label>
                    <button id="preview_message_history" class="menu_button fa-solid fa-eye interactable" title="Preview what the message history will look like"></button>
                </div>

                <label title="How many previous messages to include in the summarization prompt as context.">
                    <input id="include_message_history" class="text_pole widthUnset" type="number" min="1" max="99" />
                    <span>Number of Previous Messages</span>
                </label>

                <label title="When including previous messages, also include user messages." class="checkbox_label">
                    <input id="include_user_messages_in_history" type="checkbox" />
                    <span>Include Previous User Messages</span>
                </label>

                <hr>

                <label class="checkbox_label" title="Time in seconds to wait between summarizations. May be needed if you are using a external API with a rate limit.">
                    <input id="summarization_time_delay" class="text_pole widthUnset inline_setting" type="number" min="0" max="999" />
                    <span>Summarization Time Delay</span>
                </label>

                <label title="Editing a message will automatically trigger a re-summarization if it has already been summarized." class="checkbox_label">
                    <input id="auto_summarize_on_edit" type="checkbox" />
                    <span>Re-summarize on Edit</span>
                </label>

                <label title="Swiping a message will automatically trigger a re-summarization if it has already been summarized." class="checkbox_label">
                    <input id="auto_summarize_on_swipe" type="checkbox" />
                    <span>Re-summarize on Swipe</span>
                </label>

                <label title="Block chat input while summarizing." class="checkbox_label">
                    <input id="block_chat" type="checkbox" />
                    <span>Block Chat</span>
                </label>


                <label title="The message to summarize will be inside the system instruct template itself. In unchecked (default), the message will instead be added separately after the prompt. Some models benefit from this, but it is not recommended." class="checkbox_label">
                    <input id="nest_messages_in_prompt" type="checkbox" />
                    <span>Nest Message in Summary Prompt</span>
                </label>

                <label title="WARNING: doesn't work great. Attempts to preserve context-shifting by including all the content that is sent in regular prompts (world info, description, personas, example messages, message history, etc). If your regular prompts are static, this can allow Context Shifting to work between summarizations, but it decreases the accuracy of summarization due to all the extra stuff in the prompt. It also can't be previewed as this injection is handled by ST, not the extension." class="checkbox_label">
                    <input id="include_world_info" type="checkbox" />
                    <span>Include All Context Content</span>
                </label>


                <!-- General Injection Settings -->
                <hr>
                <h4 class="textAlignCenter">General Injection Settings <i class="fa-solid fa-info-circle" title="Determines how summaries are injected into context, applying to both short and long term memory."></i></h4>
                <label title="Separator between summaries when injected into context." class="checkbox_label">
                    <input id="summary_injection_separator" class="text_pole" type="text" placeholder="" style="width: 5em">
                    <span>Summary Injection Separator</span>
                </label>
                <label title="The number of messages to wait before summaries start to be injected." class="checkbox_label">
                    <input id="summary_injection_threshold" class="text_pole widthUnset" type="number" min="0" max="999" />
                    <span>Start Injecting After</span>
                </label>
                <label title="Messages after the summary injection threshold above will be removed from context, leaving only the summaries." class="checkbox_label">
                    <input id="exclude_messages_after_threshold" type="checkbox">
                    <span>Remove Messages After Threshold</span>
                </label>
                <label title="This will keep the most recent user message in context even if it's past the exclusion threshold" class="checkbox_label">
                    <input id="keep_last_user_message" type="checkbox">
                    <span>Preserve Last User Message</span>
                </label>


                <!-- Short-term memory -->
                <hr>
                <h4 class="textAlignCenter">Short-term Memory Injection <i class="fa-solid fa-info-circle" title="Determines which messages are included in the short-term memory injection and where. If you change this and include messages that weren't summarized previously, you can either manually trigger a re-summarization or just wait until automatic summarization triggers."></i></h4>

                <div class="flex-container justifyspacebetween alignitemscenter">
                    <button id="edit_short_term_memory_prompt" class="menu_button flex1" title="Edit the short-term memory prompt"><span>Edit Short-term Prompt</span></button>
                    <!--<button id="preview_short_term_memory" class="menu_button fa-solid fa-eye interactable" title="Preview the short-term memory injection" tabindex="0"></button>-->
                </div>

                <label title="Auto-summarize user messages and include summaries in memory." class="checkbox_label">
                    <input id="include_user_messages" type="checkbox" />
                    <span>Include User Messages</span>
                </label>

                <label title="Auto-summarize hidden messages and include summaries in memory (messages excluded from context)." class="checkbox_label">
                    <input id="include_system_messages" type="checkbox" />
                    <span>Include Hidden Messages</span>
                </label>

                <label title="Auto-summarize system messages and include summaries in memory (e.g. messages from the /sys command)." class="checkbox_label">
                    <input id="include_narrator_messages" type="checkbox" />
                    <span>Include System Messages</span>
                </label>

                <label title="The minimum token length a message has to be in order to get summarized.">
                    <input id="message_length_threshold" class="text_pole widthUnset inline_setting" type="number" min="0" max="999" />
                    <span>Message Length Threshold</span>
                </label>

                <br>

                <div class="flex-container justifyspacebetween">
                    <label title="The max amount of context that short-term memory can take up (percent or number of tokens).">
                        <input id="short_term_context_limit" class="text_pole widthUnset inline_setting" type="number" min="0" max="99999" />
                        <span>Context (<span id="short_term_context_limit_display"></span> tk)</span>
                    </label>
                    <div>
                        <label>
                            <input type="radio" name="short_term_context_type" value="percent" />
                            <span>%</span>
                        </label>
                        <label>
                            <input type="radio" name="short_term_context_type" value="tokens" />
                            <span>tk</span>
                        </label>
                    </div>
                </div>

                <label class="checkbox_label" title="Include short-term memory in the World Info Scan">
                    <input id="short_term_scan" type="checkbox" />
                    <span>Include in World Info Scanning</span>
                </label>
                <div class="radio_group">
                    <label title="You can instead inject it into your story string manually with the {{short_term_memory}} macro">
                        <input type="radio" name="short_term_position" value="-1" />
                        <span>Do not inject</span>
                    </label>
                    <label>
                        <input type="radio" name="short_term_position" value="2" />
                        <span>Before main prompt</span>
                    </label>
                    <label>
                        <input type="radio" name="short_term_position" value="0" />
                        <span>After main prompt</span>
                    </label>
                    <label class="flex-container alignItemsCenter" title="How many messages before the current end of the chat.">
                        <input type="radio" name="short_term_position" value="1" />
                        <span>In chat at depth</span>
                        <input id="short_term_depth" class="text_pole inline_setting" type="number" min="0" max="99" />
                        <span>as</span>
                        <select id="short_term_role" class="text_pole inline_setting">
                            <option value="0">System</option>
                            <option value="1">User</option>
                            <option value="2">Assistant</option>
                        </select>
                    </label>
                </div>

                <!-- Long-term memory -->
                <hr>
                <h4 class="textAlignCenter">Long-Term Memory Injection <i class="fa-solid fa-info-circle" title="Determines where long-term messages are injected."></i></h4>
                <div class="flex-container justifyspacebetween alignitemscenter">
                    <button id="edit_long_term_memory_prompt" class="menu_button flex1" title="Edit the long-term memory prompt"><span>Edit Long-term Prompt</span></button>
                    <!--<button id="preview_long_term_memory" class="menu_button fa-solid fa-eye interactable" title="Preview the long-term memory injection" tabindex="0"></button>-->
                </div>

                <div class="flex-container justifyspacebetween">
                    <label title="The max amount of the context that long-term memory can take up (percent or number of tokens).">
                        <input id="long_term_context_limit" class="text_pole widthUnset inline_setting" type="number" min="0" max="99999" />
                        <span>Context (<span id="long_term_context_limit_display"></span> tk)</span>
                    </label>
                   <div>
                        <label>
                            <input type="radio" name="long_term_context_type" value="percent" />
                            <span>%</span>
                        </label>
                        <label>
                            <input type="radio" name="long_term_context_type" value="tokens" />
                            <span>tk</span>
                        </label>
                    </div>

                </div>
                <label class="checkbox_label" title="Include long-term memory in the World Info Scan">
                    <input id="long_term_scan" type="checkbox" />
                    <span>Include in World Info Scanning</span>
                </label>
                <div class="radio_group">
                    <label title="You can instead inject it into your story string manually with the {{long_term_memory}} macro">
                        <input type="radio" name="long_term_position" value="-1" />
                        <span>Do not inject</span>
                    </label>
                    <label>
                        <input type="radio" name="long_term_position" value="2" />
                        <span>Before main prompt</span>
                    </label>
                    <label>
                        <input type="radio" name="long_term_position" value="0" />
                        <span>After main prompt</span>
                    </label>
                    <label class="flex-container alignItemsCenter" title="How many messages before the current end of the chat.">
                        <input type="radio" name="long_term_position" value="1" />
                        <span>In chat at depth</span>
                        <input id="long_term_depth" class="text_pole inline_setting" type="number" min="0" max="99" />
                        <span>as</span>
                        <select id="long_term_role" class="text_pole inline_setting">
                            <option value="0">System</option>
                            <option value="1">User</option>
                            <option value="2">Assistant</option>
                        </select>
                    </label>
                </div>

                <!-- Combined Summary -->
                <hr>
                <h4 class="textAlignCenter">Combined Summary <i class="fa-solid fa-info-circle" title="Combine all summaries into a single summary, removing repetition."></i></h4>
                <label class="checkbox_label" title="Enable combined summary injection.">
                    <input id="combined_summary_enabled" type="checkbox" />
                    <span>Enable Combined Summary</span>
                </label>
                <label class="checkbox_label" title="Only run combined summary after this many new summaries.">
                    <input id="combined_summary_run_interval" class="text_pole widthUnset inline_setting" type="number" min="1" max="999" />
                    <span>Combined Summary Interval</span>
                </label>
                <label class="checkbox_label" title="Show a popup notification when generating a combined summary.">
                    <input id="show_combined_summary_toast" type="checkbox" />
                    <span>Show toast popup when generating combined summary</span>
                </label>
                <div class="flex-container justifyspacebetween alignitemscenter">
                    <button id="edit_combined_summary_prompt" class="menu_button flex1" title="Edit the combined summary prompt"><span>Edit Combined Prompt</span></button>
                </div>
                <input id="combined_summary_prompt" type="hidden" />
                <input id="combined_summary_template" type="hidden" />
                <table>
                    <tr>
                        <td><span>Combined Completion Preset</span></td>
                        <td><select id="combined_summary_completion_preset" class="text_pole"></select></td>
                    </tr>
                    <tr>
                        <td><span>Combined Summary Prefill</span></td>
                        <td><input id="combined_summary_prefill" class="text_pole" type="text" placeholder="Start reply with..."></td>
                    </tr>
                </table>
                <label title="Where to inject the combined summary.">
                    <select id="combined_summary_position" class="text_pole">
                        <option value="-1">Do not inject</option>
                        <option value="2">Before main prompt</option>
                        <option value="0">After main prompt</option>
                        <option value="1">In chat at depth</option>
                    </select>
                </label>
                <label title="Depth for in-chat injection.">
                    <input id="combined_summary_depth" class="text_pole inline_setting" type="number" min="0" max="99" />
                    <span>Depth</span>
                </label>
                <label title="Role for in-chat injection.">
                    <select id="combined_summary_role" class="text_pole inline_setting">
                        <option value="0">System</option>
                        <option value="1">User</option>
                        <option value="2">Assistant</option>
                    </select>
                </label>
                <label class="checkbox_label" title="Include in World Info Scanning">
                    <input id="combined_summary_scan" type="checkbox" />
                    <span>Include in World Info Scanning</span>
                </label>
                <label title="Context limit for combined summary.">
                    <input id="combined_summary_context_limit" class="text_pole widthUnset inline_setting" type="number" min="0" max="99999" />
                    <span>Context Limit</span>
                </label>
                <label>
                    <input type="radio" name="combined_summary_context_type" value="percent" />
                    <span>%</span>
                </label>
                <label>
                    <input type="radio" name="combined_summary_context_type" value="tokens" />
                    <span>tk</span>
                </label>

                <!-- Error Detection -->
                <hr>
                <h4 class="textAlignCenter">Summary Validation <i class="fa-solid fa-info-circle" title="Configure validation for summaries to ensure they meet your criteria"></i></h4>
                <label class="checkbox_label" title="Enable two-step validation for summaries">
                    <input id="error_detection_enabled" type="checkbox" />
                    <span>Enable Summary Validation</span>
                </label>

                <!-- Regular summary validation -->
                <div class="flex-container justifyspacebetween alignitemscenter">
                    <label class="checkbox_label error_detection_setting" title="Enable validation for regular message summaries">
                        <input id="regular_summary_error_detection_enabled" type="checkbox" />
                        <span>Validate Regular Summaries</span>
                    </label>
                    <button id="edit_regular_summary_error_detection_prompt" class="menu_button error_detection_setting" title="Edit the validation prompt for regular summaries">Edit Validation Prompt</button>
                </div>

                <table class="regular_error_detection_container">
                    <tr>
                        <td><span>Validation Completion Preset</span></td>
                        <td><select id="regular_summary_error_detection_preset" class="text_pole regular_error_detection_setting"></select></td>
                    </tr>
                    <tr>
                        <td><span>Validation Prefill</span></td>
                        <td><input id="regular_summary_error_detection_prefill" class="text_pole regular_error_detection_setting" type="text" placeholder="Start reply with..."></td>
                    </tr>
                    <tr>
                        <td><span>Max Retry Attempts</span></td>
                        <td><input id="regular_summary_error_detection_retries" class="text_pole regular_error_detection_setting" type="number" min="1" max="10" value="3"></td>
                    </tr>
                </table>

                <!-- Combined summary validation -->
                <div class="flex-container justifyspacebetween alignitemscenter">
                    <label class="checkbox_label error_detection_setting" title="Enable validation for combined summaries">
                        <input id="combined_summary_error_detection_enabled" type="checkbox" />
                        <span>Validate Combined Summaries</span>
                    </label>
                    <button id="edit_combined_summary_error_detection_prompt" class="menu_button error_detection_setting" title="Edit the validation prompt for combined summaries">Edit Validation Prompt</button>
                </div>

                <table class="combined_error_detection_container">
                    <tr>
                        <td><span>Validation Completion Preset</span></td>
                        <td><select id="combined_summary_error_detection_preset" class="text_pole combined_error_detection_setting"></select></td>
                    </tr>
                    <tr>
                        <td><span>Validation Prefill</span></td>
                        <td><input id="combined_summary_error_detection_prefill" class="text_pole combined_error_detection_setting" type="text" placeholder="Start reply with..."></td>
                    </tr>
                    <tr>
                        <td><span>Max Retry Attempts</span></td>
                        <td><input id="combined_summary_error_detection_retries" class="text_pole combined_error_detection_setting" type="number" min="1" max="10" value="3"></td>
                    </tr>
                </table>

                <!-- Store the prompts in hidden inputs since they're edited via the edit dialog -->
                <input id="regular_summary_error_detection_prompt" type="hidden" />
                <input id="combined_summary_error_detection_prompt" type="hidden" />

                <!-- Auto-Hide -->
                <hr>
                <h4 class="textAlignCenter">Auto-Hide</h4>
                <label title="Automatically hide (exclude from prompts) messages older than this many messages (set -1 to disable)" class="checkbox_label">
                    <span>Auto Hide Messages Older Than The Last</span>
                    <input id="auto_hide_message_age" class="text_pole widthUnset inline_setting" type="number" min="-1" max="9999" />
                    <span>(-1 to disable)</span>
                </label>

                <!-- Misc. -->
                <hr>
                <h4 class="textAlignCenter">Misc.</h4>
                <label title="Fill your console with debug messages" class="checkbox_label">
                    <input id="debug_mode" type="checkbox" />
                    <span>Debug Mode</span>
                </label>

                <label title="Display summarizations below each message" class="checkbox_label">
                    <input id="display_memories" type="checkbox" />
                    <span>Display Memories</span>
                </label>

                <label title="Whether memory is enabled by default for new chats." class="checkbox_label">
                    <input id="default_chat_enabled" type="checkbox" />
                    <span>Enable Memory in New Chats</span>
                </label>

                <label title="Uses a global on/off state shared between all chats with this enabled. When unchecked, turning the extension on/off only applies to active chat." class="checkbox_label">
                    <input id="use_global_toggle_state" type="checkbox" />
                    <span>Use Global Toggle State</span>
                </label>

                <div class="flex-container justifyspacebetween alignitemscenter">
                    <button id="revert_settings" class="menu_button flex1 margin0" title="Revert all settings to default (not the default profile, just the default that comes with the extension). Your other profiles won't be affected.">
                        <span>Revert Settings</span>
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>

export const SCENE_BREAK_SUMMARIES_KEY = 'scene_break_summaries'; // Array of summaries
export const SCENE_BREAK_SUMMARY_INDEX_KEY = 'scene_break_summary_index'; // Current index

function renderSceneBreak(message) {
    const summaries = get_data(message, SCENE_BREAK_SUMMARIES_KEY) || [];
    const summaryIndex = get_data(message, SCENE_BREAK_SUMMARY_INDEX_KEY) || 0;
    const currentSummary = summaries[summaryIndex] || "";

    const sceneSummaryControls = `
        <div class="scene-summary-controls">
            <button class="scene-summary-generate" title="Generate scene summary"><i class="fa-solid fa-bolt"></i></button>
            <button class="scene-summary-undo" title="Undo" ${summaryIndex <= 0 ? "disabled" : ""}><i class="fa-solid fa-rotate-left"></i></button>
            <button class="scene-summary-redo" title="Redo" ${summaryIndex >= summaries.length - 1 ? "disabled" : ""}><i class="fa-solid fa-rotate-right"></i></button>
            <span class="scene-summary-version">${summaries.length ? `Version ${summaryIndex + 1} of ${summaries.length}` : "No summary"}</span>
        </div>
        <div class="scene-summary-display auto_summarize_memory_text">${currentSummary}</div>
    `;
    // Insert sceneSummaryControls after the summary textarea
    $sceneBreak.find('.scene-summary-box').after(sceneSummaryControls);

    $sceneBreak.find('.scene-summary-generate').on('click', async function () {
        await generateSceneSummary(index, getContext, get_data, set_data, saveChatDebounced);
        renderAllSceneBreaks(get_message_div, getContext, get_data, set_data, saveChatDebounced);
    });
    $sceneBreak.find('.scene-summary-undo').on('click', function () {
        let idx = get_data(message, SCENE_BREAK_SUMMARY_INDEX_KEY) || 0;
        if (idx > 0) {
            set_data(message, SCENE_BREAK_SUMMARY_INDEX_KEY, idx - 1);
            saveChatDebounced();
            renderAllSceneBreaks(get_message_div, getContext, get_data, set_data, saveChatDebounced);
        }
    });
    $sceneBreak.find('.scene-summary-redo').on('click', function () {
        let idx = get_data(message, SCENE_BREAK_SUMMARY_INDEX_KEY) || 0;
        let summaries = get_data(message, SCENE_BREAK_SUMMARIES_KEY) || [];
        if (idx < summaries.length - 1) {
            set_data(message, SCENE_BREAK_SUMMARY_INDEX_KEY, idx + 1);
            saveChatDebounced();
            renderAllSceneBreaks(get_message_div, getContext, get_data, set_data, saveChatDebounced);
        }
    });
}

async function generateSceneSummary(index, getContext, get_data, set_data, saveChatDebounced) {
    const ctx = getContext();
    const chat = ctx.chat;
    const message = chat[index];

    // Find scene message indexes (reuse logic from renderSceneBreak)
    let startIdx = 0;
    for (let i = index - 1; i >= 0; i--) {
        if (
            get_data(chat[i], SCENE_BREAK_KEY) &&
            (get_data(chat[i], SCENE_BREAK_VISIBLE_KEY) === undefined || get_data(chat[i], SCENE_BREAK_VISIBLE_KEY))
        ) {
            startIdx = i + 1;
            break;
        }
    }
    const sceneMessages = [];
    for (let i = startIdx; i <= index; i++) {
        sceneMessages.push(chat[i]);
    }

    // Get settings for scene summary
    const promptTemplate = get_settings('scene_summary_prompt') || "Summarize the following scene:\n{{scene}}\n";
    const connectionProfile = get_settings('scene_summary_connection_profile') || "";
    const completionPreset = get_settings('scene_summary_completion_preset') || "";

    // Build scene text
    const sceneText = sceneMessages.map(m => m.mes).join('\n');

    // Fill prompt
    const prompt = promptTemplate.replace('{{scene}}', sceneText);

    // Temporarily switch profile/preset if needed
    const currentProfile = await get_current_connection_profile();
    const currentPreset = await get_current_preset();
    await set_connection_profile(connectionProfile);
    await set_preset(completionPreset);

    // Generate summary
    let summary = await summarize_text(prompt);

    // Restore profile/preset
    await set_connection_profile(currentProfile);
    await set_preset(currentPreset);

    // Save summary version
    let summaries = get_data(message, SCENE_BREAK_SUMMARIES_KEY) || [];
    summaries = summaries.slice(0, (get_data(message, SCENE_BREAK_SUMMARY_INDEX_KEY) || summaries.length - 1) + 1); // Truncate redo history
    summaries.push(summary);
    set_data(message, SCENE_BREAK_SUMMARIES_KEY, summaries);
    set_data(message, SCENE_BREAK_SUMMARY_INDEX_KEY, summaries.length - 1);
    saveChatDebounced();
}