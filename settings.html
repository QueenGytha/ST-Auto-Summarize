<div id="auto_summarize_memory_settings" class="auto_summarize_memory_settings_content">
    <div class="inline-drawer">

        <div class="inline-drawer-toggle inline-drawer-header">
            <div class="flex-container alignitemscenter margin0">
                <b>ST-Auto-Summarize</b>
                <i id="auto_summarize_popout_button" class="fa-solid fa-window-restore menu_button margin0"></i>
            </div>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
        </div>

        <div class="inline-drawer-content">

            <!-- transferred to popup -->
            <div class="auto_summarize_memory_settings_content">
                <hr>

                <div class="flex-container justifyspacebetween alignitemscenter">
                    <button id="toggle_chat_memory" class="menu_button flex2" title="Toggle whether memory is enabled for this chat specifically (overrides all settings)."><span>Toggle Memory</span></button>
                    <button id="refresh_memory" class="menu_button fa-solid fa-sync margin0" title="Just refreshes which memories are included and re-renders the memories under each message, doesn't change summaries. This is done automatically all the time, the button is here just in case."></button>
                </div>

                <hr>

                <div class="flex-container alignitemscenter margin0">
                    <h4 class="margin0">Configuration Profiles</h4>
                    <button id="import_profile"     class="menu_button fa-solid fa-file-import"    title="Import a config profile"></button>
                    <button id="export_profile"     class="menu_button fa-solid fa-file-export"    title="Export the current config profile"></button>
                    <input id="import_file" type="file" hidden="" accept=".json">
                </div>
                <div class="flex-container justifyspacebetween alignitemscenter">
                    <select id="profile"            class="flex1 text_pole"                                 title="The currently selected profile"></select>
                    <button id="rename_profile"     class="menu_button fa-solid fa-pencil interactable"     title="Rename current profile" tabindex="0"></button>
                    <button id="new_profile"        class="menu_button fa-solid fa-file-circle-plus interactable" title="Create new profile" tabindex="0"></button>
                    <button id="restore_profile"    class="menu_button fa-solid fa-recycle interactable"    title="Restore current profile" tabindex="0"></button>
                    <button id="delete_profile"     class="menu_button fa-solid fa-trash-can interactable"  title="Delete current profile" tabindex="0"></button>
                </div>
                <div class="flex-container justifyspacebetween alignitemscenter">
                    <button id="character_profile" class="menu_button interactable" title="Auto-load profile for current character" tabindex="0"><i class="fa-solid fa-unlock" style="margin-right: 1em"></i>Character</button>
                    <button id="chat_profile"      class="menu_button interactable" title="Auto-load profile for current chat"      tabindex="0"><i class="fa-solid fa-unlock" style="margin-right: 1em"></i>Chat</button>
                    <label class="checkbox_label" title="Show a notification upon switching profiles">
                        <input id="notify_on_profile_switch" type="checkbox" />
                        <span>Notify on Switch</span>
                    </label>
                </div>

                <!-- First-Hop Proxy Integration -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">First-Hop Proxy Integration <i class="fa-solid fa-info-circle" title="Add metadata to LLM requests for downstream proxy logging and tracking."></i></h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <label title="Send chat details (chat name/ID) in LLM requests for proxy logging." class="checkbox_label">
                            <input id="first_hop_proxy_send_chat_details" type="checkbox" />
                            <span>Send Chat Details</span>
                        </label>

                        <label title="Wraps each lorebook entry individually with &lt;lorebook&gt; tags for downstream parsing. Supports multi-line entries. Tags are stripped by proxy before sending to LLM." class="checkbox_label">
                            <input id="wrap_lorebook_entries" type="checkbox" />
                            <span>Wrap Lorebook Entries</span>
                        </label>

                        <div class="note-block">
                            <i class="fa-solid fa-info-circle"></i>
                            <span>When enabled, metadata is added to LLM requests that your proxy can parse and strip before forwarding to the LLM. This allows your proxy to log requests with chat context.</span>
                        </div>
                    </div>
                </div>

                <!-- General Injection Settings -->
                <!-- Message Filtering -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Message Filtering <i class="fa-solid fa-info-circle" title="Controls which messages are included in scene summaries and other features."></i></h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <label title="Include user messages in scene summaries and other features." class="checkbox_label">
                            <input id="include_user_messages" type="checkbox" />
                            <span>Include User Messages</span>
                        </label>

                        <label title="Include hidden messages in scene summaries and other features (messages excluded from context)." class="checkbox_label">
                            <input id="include_system_messages" type="checkbox" />
                            <span>Include Hidden Messages</span>
                        </label>

                        <label title="Include system messages in scene summaries and other features (e.g. messages from the /sys command)." class="checkbox_label">
                            <input id="include_narrator_messages" type="checkbox" />
                            <span>Include System Messages</span>
                        </label>

                        <label title="The minimum token length a message has to be in order to be included.">
                            <input id="message_length_threshold" class="text_pole widthUnset inline_setting" type="number" min="0" max="999" />
                            <span>Message Length Threshold</span>
                        </label>
                    </div>
                </div>

                <!-- Scene Summary -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Scene Summary <i class="fa-solid fa-info-circle" title="Summarize each scene break and use the results to build the running scene summary."></i></h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <label title="Width of the scene navigator bar in pixels.">
                            <span>Navigator Bar Width (pixels):</span>
                            <input id="scene_summary_navigator_width" class="text_pole" type="number" min="30" max="500" step="1" />
                        </label>
                        <label title="Font size for scene names in the navigator bar (in pixels).">
                            <span>Navigator Font Size (pixels):</span>
                            <input id="scene_summary_navigator_font_size" class="text_pole" type="number" min="8" max="24" step="1" />
                        </label>
                        <label class="checkbox_label" title="Automatically generate a brief scene name (like a chapter title) when auto-generating scene summaries (e.g., during scene break detection), if no name is already set.">
                            <input id="scene_summary_auto_name" type="checkbox" />
                            <span>Auto-generate Scene Names (Auto-Detection)</span>
                        </label>
                        <label class="checkbox_label" title="Automatically generate a brief scene name (like a chapter title) when manually generating scene summaries via the Generate button, if no name is already set.">
                            <input id="scene_summary_auto_name_manual" type="checkbox" />
                            <span>Auto-generate Scene Names (Manual)</span>
                        </label>
                        <label class="checkbox_label" title="New scene summaries will start collapsed by default (showing only the scene name). Existing scenes keep their current state.">
                            <input id="scene_summary_default_collapsed" type="checkbox" />
                            <span>Collapse New Scenes by Default</span>
                        </label>
                        <div class="flex-container justifyspacebetween alignitemscenter">
                            <button id="edit_scene_summary_prompt" class="menu_button flex1" title="Edit the scene summary prompt"><span>Edit Scene Prompt</span></button>
                        </div>
                        <small class="displayBlock opacity50p">Available macros: {{scene_messages}}, {{lorebook_entry_types}}, {{char}}, {{user}}</small>
                        <input id="scene_summary_prompt" type="hidden" />
                        <input id="scene_summary_default_prompt" type="hidden" value="[Default scene summary prompt here]" />
                        <table>
                            <tr>
                                <td><span>Scene Completion Preset</span></td>
                                <td><select id="scene_summary_completion_preset" class="text_pole"></select></td>
                            </tr>
                            <tr>
                                <td><span>Scene Connection Profile</span></td>
                                <td><select id="scene_summary_connection_profile" class="text_pole"></select></td>
                            </tr>
                            <tr>
                                <td><span>Scene Summary Prefill</span></td>
                                <td><input id="scene_summary_prefill" class="text_pole" type="text" placeholder="Start reply with..."></td>
                            </tr>
                            <tr>
                                <td><span>Include Message Types</span></td>
                                <td>
                                    <select id="scene_summary_message_types" class="text_pole">
                                        <option value="user">User Messages Only</option>
                                        <option value="character">AI Messages Only</option>
                                        <option value="both">All Messages</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <span>Summarize the last <span id="scene_summary_history_count_display">1</span> scenes</span>
                                </td>
                                <td>
                                    <input id="scene_summary_history_count" class="text_pole" type="number" min="1" max="99" value="1" />
                                </td>
                            </tr>
                        </table>
                        <label title="Context limit for scene summary.">
                            <input id="scene_summary_context_limit" class="text_pole widthUnset inline_setting" type="number" min="0" max="99999" />
                            <span>Context Limit</span>
                        </label>
                        <label>
                            <input type="radio" name="scene_summary_context_type" value="percent" />
                            <span>%</span>
                        </label>
                        <label>
                            <input type="radio" name="scene_summary_context_type" value="tokens" />
                            <span>tk</span>
                        </label>
                    </div>
                </div>

                <!-- Running Scene Summary -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Running Scene Summary <i class="fa-solid fa-info-circle" title="Combine multiple scene summaries into a single cohesive memory. This is the recommended default behavior matching best practices."></i></h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <label title="Number of latest scene summaries to exclude from the running summary. Default: 1 (allows you to validate the latest scene summary before it's combined).">
                            <span>Exclude Latest <span id="running_scene_summary_exclude_latest_display">1</span> Scene(s)</span>
                            <input id="running_scene_summary_exclude_latest" class="text_pole" type="range" min="0" max="5" step="1" value="1" />
                        </label>
                        <small style="display:block; margin-bottom:0.5em;">Recommended: 1 (exclude latest scene to allow manual validation before combining)</small>

                        <label class="checkbox_label" title="Automatically generate running scene summary when new scene summaries are created.">
                            <input id="running_scene_summary_auto_generate" type="checkbox" />
                            <span>Auto-generate on New Scene Summaries</span>
                        </label>

                        <label class="checkbox_label" title="Show version control buttons in the navbar to switch between, edit, or delete running summary versions.">
                            <input id="running_scene_summary_show_navbar" type="checkbox" />
                            <span>Show Navbar Version Controls</span>
                        </label>

                        <div class="flex-container justifyspacebetween alignitemscenter">
                            <button id="view_running_scene_summary" class="menu_button flex2" title="View/edit the current running scene summary"><span>View Running Summary</span></button>
                            <button id="edit_running_scene_summary_prompt" class="menu_button flex1" title="Edit the running scene summary prompt"><span>Edit Running Summary Prompt</span></button>
                        </div>
                        <input id="running_scene_summary_prompt" type="hidden" />

                        <table>
                            <tr>
                                <td><span>Running Summary Completion Preset</span></td>
                                <td><select id="running_scene_summary_completion_preset" class="text_pole"></select></td>
                            </tr>
                            <tr>
                                <td><span>Running Summary Connection Profile</span></td>
                                <td><select id="running_scene_summary_connection_profile" class="text_pole"></select></td>
                            </tr>
                            <tr>
                                <td><span>Running Summary Prefill</span></td>
                                <td><input id="running_scene_summary_prefill" class="text_pole" type="text" placeholder="Start reply with..."></td>
                            </tr>
                        </table>

                        <label title="Where to inject the running scene summary.">
                            <select id="running_scene_summary_position" class="text_pole">
                                <option value="-1">Do not inject</option>
                                <option value="2">Before main prompt</option>
                                <option value="0">After main prompt</option>
                                <option value="1">In chat at depth</option>
                            </select>
                        </label>
                        <label title="Depth for in-chat injection.">
                            <input id="running_scene_summary_depth" class="text_pole inline_setting" type="number" min="0" max="99" />
                            <span>Depth</span>
                        </label>
                        <label title="Role for in-chat injection.">
                            <select id="running_scene_summary_role" class="text_pole inline_setting">
                                <option value="0">System</option>
                                <option value="1">User</option>
                                <option value="2">Assistant</option>
                            </select>
                        </label>
                        <label class="checkbox_label" title="Include in World Info Scanning">
                            <input id="running_scene_summary_scan" type="checkbox" />
                            <span>Include in World Info Scanning</span>
                        </label>
                        <label title="Context limit for running scene summary.">
                            <input id="running_scene_summary_context_limit" class="text_pole widthUnset inline_setting" type="number" min="0" max="99999" />
                            <span>Context Limit</span>
                        </label>
                        <label>
                            <input type="radio" name="running_scene_summary_context_type" value="percent" />
                            <span>%</span>
                        </label>
                        <label>
                            <input type="radio" name="running_scene_summary_context_type" value="tokens" />
                            <span>tk</span>
                        </label>
                    </div>
                </div>

                <!-- Auto Scene Break Detection -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Auto Scene Break Detection <i class="fa-solid fa-info-circle" title="Automatically detect and mark scene breaks using AI analysis."></i></h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <!-- Removed master enable toggle: scene break detection is always available.
                             Behavior is governed by per-event options and manual run. -->
                        <label class="checkbox_label" title="Automatically check for scene breaks when chat loads.">
                            <input id="auto_scene_break_on_load" type="checkbox" />
                            <span>Auto-check on Chat Load</span>
                        </label>
                        <label class="checkbox_label" title="Automatically check for scene breaks when new messages arrive.">
                            <input id="auto_scene_break_on_new_message" type="checkbox" />
                            <span>Auto-check on New Messages</span>
                        </label>
                        <label class="checkbox_label" title="Automatically generate a scene summary when a scene break is detected. The summary generation will complete before checking the next message.">
                            <input id="auto_scene_break_generate_summary" type="checkbox" />
                            <span>Auto-generate Scene Summary on Detection</span>
                        </label>

                        <label title="How many messages back from the latest to skip checking. 0 = check all including latest, 1 = skip latest, 2 = skip 2 latest, etc.">
                            <span>Message Offset (skip latest N messages): <span id="auto_scene_break_message_offset_value">1</span></span>
                            <input id="auto_scene_break_message_offset" class="text_pole" type="range" min="0" max="10" step="1" value="1" />
                        </label>
                        <small style="display:block; margin-bottom:0.5em;">Recommended: 1 (skip latest message since you may not like it yet)</small>

                        <label title="How many recent messages of the selected type to check for scene breaks when new messages arrive. Set to 0 to scan the entire history.">
                            <span>Recent Messages to Check:</span>
                            <input id="auto_scene_break_recent_message_count" class="text_pole" type="number" min="0" max="50" step="1" />
                        </label>
                        <small style="display:block; margin-bottom:0.5em;">Counts messages that match the selected message type filter.</small>

                        <label title="Which message types to check for scene breaks.">
                            <span>Check Which Messages:</span>
                            <select id="auto_scene_break_check_which_messages" class="text_pole">
                                <option value="character">AI Messages Only</option>
                                <option value="user">User Messages Only</option>
                                <option value="both">Both User and AI Messages</option>
                            </select>
                        </label>
                        <small style="display:block; margin-bottom:0.5em;">Scene breaks typically occur in AI responses, but some users write them in their inputs too.</small>

                        <div class="flex-container justifyspacebetween alignitemscenter">
                            <button id="edit_auto_scene_break_prompt" class="menu_button flex1" title="Edit the auto scene break detection prompt"><span>Edit Detection Prompt</span></button>
                        </div>

                        <input id="auto_scene_break_prompt" type="hidden" />

                        <table>
                            <tr title="The connection profile to use for scene break detection. Leave empty to use current profile.">
                                <td><span>Detection Connection Profile</span></td>
                                <td><select id="auto_scene_break_connection_profile" class="text_pole"></select></td>
                            </tr>
                            <tr title="The completion preset to use for scene break detection. Leave empty to use current preset.">
                                <td><span>Detection Completion Preset</span></td>
                                <td><select id="auto_scene_break_completion_preset" class="text_pole"></select></td>
                            </tr>
                            <tr title="Start the detection with this prefilled text to enforce true/false output.">
                                <td><span>Detection Prefill</span></td>
                                <td><input id="auto_scene_break_prefill" class="text_pole" type="text" placeholder=""></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Error Detection -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Summary Validation <i class="fa-solid fa-info-circle" title="Configure validation for summaries to ensure they meet your criteria"></i></h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <label class="checkbox_label" title="Enable two-step validation for summaries">
                            <input id="error_detection_enabled" type="checkbox" />
                            <span>Enable Summary Validation</span>
                        </label>

                <!-- Scene summary validation -->
                <label class="checkbox_label error_detection_setting" title="Enable validation for scene summaries">
                    <input id="scene_summary_error_detection_enabled" type="checkbox" />
                    <span>Validate Scene Summaries</span>
                </label>
                <div class="flex-container justifyspacebetween alignitemscenter">
                    <button id="edit_scene_summary_error_detection_prompt" class="menu_button flex1 error_detection_setting" title="Edit the validation prompt for scene summaries"><span>Edit Scene Summary Validation Prompt</span></button>
                </div>
                <table class="scene_error_detection_container">
                    <tr>
                        <td><span>Scene Summary Validation Preset</span></td>
                        <td><select id="scene_summary_error_detection_preset" class="text_pole scene_error_detection_setting"></select></td>
                    </tr>
                    <tr>
                        <td><span>Scene Summary Validation Prefill</span></td>
                        <td><input id="scene_summary_error_detection_prefill" class="text_pole scene_error_detection_setting" type="text" placeholder="Start reply with..."></td>
                    </tr>
                    <tr>
                        <td><span>Scene Summary Max Retry Attempts</span></td>
                        <td><input id="scene_summary_error_detection_retries" class="text_pole scene_error_detection_setting" type="number" min="1" max="10" value="3"></td>
                    </tr>
                </table>
                <input id="scene_summary_error_detection_prompt" type="hidden" />
                    </div>
                </div>

                <!-- Auto-Hide -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Auto-Hide</h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <label title="Automatically hide all messages in scenes older than this many scenes (set -1 to disable)" class="checkbox_label">
                            <span>Auto Hide Messages Older Than The Last</span>
                            <input id="auto_hide_scene_count" class="text_pole widthUnset inline_setting" type="number" min="-1" max="999" />
                            <span>Scene(s) (-1 to disable)</span>
                        </label>
                    </div>
                </div>

                <!-- Misc. -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Misc.</h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <label title="Whether memory is enabled by default for new chats." class="checkbox_label">
                            <input id="default_chat_enabled" type="checkbox" />
                            <span>Enable Memory in New Chats</span>
                        </label>

                        <label title="Uses a global on/off state shared between all chats with this enabled. When unchecked, turning the extension on/off only applies to active chat." class="checkbox_label">
                            <input id="use_global_toggle_state" type="checkbox" />
                            <span>Use Global Toggle State</span>
                        </label>
                    </div>
                </div>

                <!-- Auto-Lorebooks Settings -->
                <hr>
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <div class="flex-container alignitemscenter margin0">
                            <h4 class="margin0">Auto-Lorebooks</h4>
                        </div>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <div class="margin-bot-10px">
                            <label class="checkbox_label" for="autolorebooks-delete-on-chat-delete">
                                <input type="checkbox" id="autolorebooks-delete-on-chat-delete" />
                                <span>Delete lorebook when chat is deleted</span>
                            </label>
                        </div>

                        <div class="margin-bot-10px">
                            <label class="checkbox_label" for="autolorebooks-auto-reorder-alphabetically">
                                <input type="checkbox" id="autolorebooks-auto-reorder-alphabetically" />
                                <span>Auto-reorder entries alphabetically when created or renamed</span>
                            </label>
                        </div>

                        <div class="margin-bot-10px">
                            <label for="autolorebooks-name-template">
                                <span>Lorebook naming template:</span>
                                <small class="displayBlock opacity50p">Available variables: {{char}}, {{chat}}</small>
                            </label>
                            <input type="text" id="autolorebooks-name-template" class="text_pole" placeholder="z-AutoLB-{{chat}}" />
                        </div>
                        <div class="margin-bot-10px">
                            <label>
                                <span>Supported lorebook entry types:</span>
                                <small class="displayBlock opacity50p">Applies to the {{lorebook_entry_types}} macro and registry generation. Values should be lowercase slugs.</small>
                            </label>
                            <div id="autolorebooks-entity-types-list" class="margin-top-5px"></div>
                            <div class="flex-container alignitemscenter margin-top-5px" style="gap: 5px;">
                                <input type="text" id="autolorebooks-entity-type-input" class="text_pole" placeholder="e.g. quest(entry:constant)" />
                                <button id="autolorebooks-add-entity-type" class="menu_button">Add</button>
                                <button id="autolorebooks-restore-entity-types" class="menu_button fa-solid fa-recycle" title="Restore default types"></button>
                            </div>
                        </div>

                        <hr>

                        <h4>Summary-to-Lorebook Processing</h4>

                        <div class="margin-bot-10px">
                            <label class="checkbox_label" for="autolorebooks-summary-skip-duplicates">
                                <input type="checkbox" id="autolorebooks-summary-skip-duplicates" />
                                <span>Skip already processed summaries</span>
                            </label>
                        </div>

                        <div class="inline-drawer margin-top-10px">
                            <div class="inline-drawer-toggle inline-drawer-header">
                                <div class="flex-container alignitemscenter margin0">
                                    <span>Entry Merge Settings (When Processing Summaries)</span>
                                </div>
                                <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                            </div>
                            <div class="inline-drawer-content">
                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-summary-merge-connection">
                                        <span>Connection Profile:</span>
                                        <small class="displayBlock opacity50p">Which API to use for merging lorebook entries (empty = use main API)</small>
                                    </label>
                                    <select id="autolorebooks-summary-merge-connection" class="text_pole">
                                        <option value="">Main API</option>
                                    </select>
                                </div>

                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-summary-merge-preset">
                                        <span>Completion Preset:</span>
                                        <small class="displayBlock opacity50p">Preset to use for merging entries (empty = use default)</small>
                                    </label>
                                    <select id="autolorebooks-summary-merge-preset" class="text_pole">
                                        <option value="">Default</option>
                                    </select>
                                </div>

                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-summary-merge-prefill">
                                        <span>Prefill (Claude models):</span>
                                        <small class="displayBlock opacity50p">Text to prefill AI response</small>
                                    </label>
                                    <input type="text" id="autolorebooks-summary-merge-prefill" class="text_pole" placeholder="" />
                                </div>

                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-summary-merge-prompt">
                                        <span>Lorebook entry merge prompt:</span>
                                        <small class="displayBlock opacity50p">Use {{existing_content}} and {{new_content}}. Merges new summary data with existing entry content.</small>
                                    </label>
                                    <textarea id="autolorebooks-summary-merge-prompt" class="text_pole textarea_compact" rows="10"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="inline-drawer margin-top-10px">
                            <div class="inline-drawer-toggle inline-drawer-header">
                                <div class="flex-container alignitemscenter margin0">
                                    <span>Duplicate Detection Settings</span>
                                </div>
                                <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                            </div>
                            <div class="inline-drawer-content">
                                <h5 class="margin-top-0">Stage 1 – Registry Lorebook Entry Lookup</h5>
                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-summary-lorebook-entry-lookup-connection">
                                        <span>Connection Profile:</span>
                                        <small class="displayBlock opacity50p">API profile to use when screening new entries (empty = use main API)</small>
                                    </label>
                                    <select id="autolorebooks-summary-lorebook-entry-lookup-connection" class="text_pole">
                                        <option value="">Main API</option>
                                    </select>
                                </div>
                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-summary-lorebook-entry-lookup-preset">
                                        <span>Completion Preset:</span>
                                        <small class="displayBlock opacity50p">Preset for triage calls (empty = use default)</small>
                                    </label>
                                    <select id="autolorebooks-summary-lorebook-entry-lookup-preset" class="text_pole">
                                        <option value="">Default</option>
                                    </select>
                                </div>
                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-summary-lorebook-entry-lookup-prefill">
                                        <span>Prefill (Claude models):</span>
                                        <small class="displayBlock opacity50p">Optional text to prefill AI responses during triage</small>
                                    </label>
                                    <input type="text" id="autolorebooks-summary-lorebook-entry-lookup-prefill" class="text_pole" placeholder="" />
                                </div>
                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-summary-lorebook-entry-lookup-prompt" class="flex-container alignitemscenter justifyspacebetween">
                                        <span>Lorebook Entry Lookup prompt:</span>
                                        <button id="restore-summary-triage-prompt" class="menu_button fa-solid fa-recycle" title="Restore default triage prompt"></button>
                                    </label>
                                    <small class="displayBlock opacity50p">Use macros: {{lorebook_entry_types}}, {{new_entry}}, {{candidate_registry}}</small>
                                    <textarea id="autolorebooks-summary-lorebook-entry-lookup-prompt" class="text_pole textarea_compact" rows="10"></textarea>
                                </div>

                                <h5>Stage 2 – Full LorebookEntryDeduplicate</h5>
                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-summary-entry-deduplicate-connection">
                                        <span>Connection Profile:</span>
                                        <small class="displayBlock opacity50p">API profile when comparing full entries (empty = use main API)</small>
                                    </label>
                                    <select id="autolorebooks-summary-entry-deduplicate-connection" class="text_pole">
                                        <option value="">Main API</option>
                                    </select>
                                </div>
                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-summary-entry-deduplicate-preset">
                                        <span>Completion Preset:</span>
                                        <small class="displayBlock opacity50p">Preset for the follow-up comparison call (empty = use default)</small>
                                    </label>
                                    <select id="autolorebooks-summary-entry-deduplicate-preset" class="text_pole">
                                        <option value="">Default</option>
                                    </select>
                                </div>
                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-summary-entry-deduplicate-prefill">
                                        <span>Prefill (Claude models):</span>
                                        <small class="displayBlock opacity50p">Optional text to prefill the comparison response</small>
                                    </label>
                                    <input type="text" id="autolorebooks-summary-entry-deduplicate-prefill" class="text_pole" placeholder="" />
                                </div>
                                <div class="margin-bot-10px">
                                    <label for="autolorebooks-summary-entry-deduplicate-prompt" class="flex-container alignitemscenter justifyspacebetween">
                                        <span>LorebookEntryDeduplicate prompt:</span>
                                        <button id="restore-summary-entry-deduplicate-prompt" class="menu_button fa-solid fa-recycle" title="Restore default LorebookEntryDeduplicate prompt"></button>
                                    </label>
                                    <small class="displayBlock opacity50p">Use macros: {{lorebook_entry_types}}, {{new_entry}}, {{triage_synopsis}}, {{candidate_entries}}</small>
                                    <textarea id="autolorebooks-summary-entry-deduplicate-prompt" class="text_pole textarea_compact" rows="10"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>
                <div class="flex-container justifyspacebetween alignitemscenter">
                    <button id="revert_settings" class="menu_button flex1 margin0" title="Restore all settings to their default values. This completely resets all configuration options to factory defaults. Your saved profiles won't be affected.">
                        <span>Restore All Defaults</span>
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>
